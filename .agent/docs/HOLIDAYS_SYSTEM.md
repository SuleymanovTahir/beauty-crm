# Система управления праздниками салона

## Обзор

Реализована полная система управления праздничными днями салона с поддержкой исключений для отдельных мастеров.

## Функциональность

### 1. База данных

**Таблица:** `salon_holidays`

- `id` - уникальный идентификатор
- `date` - дата праздника (уникальная)
- `name` - название праздника
- `is_closed` - флаг закрытия салона (по умолчанию true)
- `master_exceptions` - JSON массив ID мастеров, которые работают в этот день
- `created_at` - дата создания записи

**Миграция:** `/backend/db/migrations/consolidated/schema_holidays.py`

- Автоматическое создание таблицы
- Добавление колонки `master_exceptions` для существующих систем
- Индекс по полю `date` для быстрого поиска

### 2. Backend API

**Endpoints:**

- `GET /api/holidays` - получить список праздников

  - Параметры: `start_date`, `end_date` (опционально)
  - Возвращает: массив праздников с исключениями

- `POST /api/holidays` - создать праздник

  - Тело запроса:
    ```json
    {
      "date": "2026-01-01",
      "name": "Новый год",
      "is_closed": true,
      "master_exceptions": [1, 3, 5]
    }
    ```

- `DELETE /api/holidays/{date}` - удалить праздник

**Файлы:**

- `/backend/api/holidays.py` - API роутер
- `/backend/db/holidays.py` - функции работы с БД
- `/backend/db/migrations/consolidated/schema_holidays.py` - миграции и CRUD

### 3. Интеграция с расписанием мастеров

**Файл:** `/backend/services/master_schedule.py`

**Методы обновлены:**

- `is_master_available()` - проверка доступности мастера

  - Проверяет праздники салона
  - Если салон закрыт, проверяет наличие мастера в исключениях
  - Возвращает `False` если салон закрыт и мастер не в исключениях

- `get_available_slots()` - получение доступных слотов
  - Аналогичная проверка праздников
  - Возвращает пустой массив если мастер недоступен в праздник

**Логика:**

1. Проверка наличия праздника на указанную дату
2. Если `is_closed = true`:
   - Парсинг JSON массива `master_exceptions`
   - Проверка наличия `user_id` мастера в исключениях
   - Блокировка доступности если мастер не в исключениях
3. Продолжение стандартной проверки расписания

### 4. Frontend UI

**Файл:** `/frontend/src/pages/admin/Settings.tsx`

**Вкладка "Holidays":**

- Список всех праздников с информацией:
  - Название и дата
  - Статус "Закрыто"
  - Список работающих мастеров (исключения)
- Кнопка "Добавить праздник"

**Диалог создания праздника:**

- Поле выбора даты
- Поле ввода названия
- Переключатель "Салон закрыт"
- Мультиселект мастеров-исключений (показывается только если салон закрыт):
  - Список всех мастеров с чекбоксами
  - Отображение полного имени и username
  - Счетчик выбранных мастеров

**Состояние:**

```typescript
const [holidayForm, setHolidayForm] = useState({
  date: "",
  name: "",
  is_closed: true,
  master_exceptions: [] as number[],
});
```

### 5. API Client

**Файл:** `/frontend/src/services/api.ts`

**Методы:**

- `getHolidays(start?, end?)` - получить праздники
- `createHoliday(data)` - создать праздник
- `deleteHoliday(date)` - удалить праздник

### 6. Переводы

**Файл:** `/frontend/src/locales/ru/admin/settings.json`

Добавлены ключи:

- `holidays` - "Праздники салона"
- `manage_holidays_desc` - "Управление праздничными днями и выходными салона"
- `add_holiday` - "Добавить праздник"
- `master_exceptions` - "Мастера, которые будут работать"
- `master_exceptions_hint` - подсказка о выборе исключений
- `working_masters` - "Работающие мастера"
- `closed` - "Закрыто"
- И другие связанные переводы

## Использование

### Создание праздника

1. Перейти в Settings → Holidays
2. Нажать "Добавить праздник"
3. Выбрать дату и ввести название
4. Если салон закрыт, выбрать мастеров-исключений (опционально)
5. Нажать "Создать"

### Результат

- В указанную дату салон будет считаться закрытым
- Все мастера будут недоступны для записи
- Исключение: выбранные мастера останутся доступными
- Система автоматически учитывает это при:
  - Проверке доступности времени
  - Генерации списка свободных слотов
  - Создании новых записей

## Технические детали

### Проверка праздников

```python
# В методах is_master_available и get_available_slots
c.execute("""
    SELECT is_closed, master_exceptions
    FROM salon_holidays
    WHERE date = %s
""", (date,))

holiday = c.fetchone()
if holiday:
    is_closed, master_exceptions_json = holiday
    if is_closed:
        exceptions = json.loads(master_exceptions_json) if master_exceptions_json else []
        if user_id not in exceptions:
            return False  # Мастер недоступен
```

### Хранение исключений

- Формат: JSON массив ID мастеров `[1, 3, 5]`
- Хранится как TEXT в PostgreSQL
- Автоматическая сериализация/десериализация в Python

## Будущие улучшения

1. Возможность редактирования существующих праздников
2. Повторяющиеся праздники (ежегодные)
3. Частичное закрытие (сокращенный рабочий день)
4. Импорт/экспорт праздников
5. Шаблоны праздников по странам
