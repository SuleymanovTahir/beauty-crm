# Полная инструкция деплоя Beauty CRM (split: site + crm)

## 1. Текущая архитектура

- `crm` и `site` работают как два независимых runtime.
- Домен один: `https://mlediamant.com`.
- Маршрутизация в проде:
  - `https://mlediamant.com/` -> `site` frontend + `site` backend
  - `https://mlediamant.com/crm/` -> `crm` frontend + `crm` backend
  - `https://mlediamant.com/api/*` -> `site` backend
  - `https://mlediamant.com/crm/api/*` -> `crm` backend

Важно: для текущего CRM frontend WebSocket endpoints идут на `/api/ws/*` и `/api/webrtc/*`, поэтому в nginx они направляются в `crm` backend.

---

## 2. Локальный запуск

### Вариант A: только CRM

Backend:
```bash
cd /Users/tahir/Desktop/beauty-crm/crm/backend
source venv/bin/activate
PORT=8001 python3 -m uvicorn main:app --reload --host 0.0.0.0 --port 8001
```

Frontend:
```bash
cd /Users/tahir/Desktop/beauty-crm/crm/frontend
BACKEND_PORT=8001 FRONTEND_PORT=5174 npm run dev
```

Открывать:
- `http://localhost:5174/crm/login`

### Вариант B: только Site (public/account/admin)

Backend:
```bash
cd /Users/tahir/Desktop/beauty-crm/site/backend
source venv/bin/activate
PORT=8002 python3 -m uvicorn main:app --reload --host 0.0.0.0 --port 8002
```

Frontend:
```bash
cd /Users/tahir/Desktop/beauty-crm/site/frontend
BACKEND_PORT=8002 FRONTEND_PORT=5173 npm run dev
```

Открывать:
- `http://localhost:5173/`

### Вариант C: одновременно CRM + Site

Запустить 4 процесса (2 backend + 2 frontend) командами из Варианта A и B.

Навигация между контурами:
- из site -> открывать `http://localhost:5174/crm/login`
- из crm -> открывать `http://localhost:5173/`

---

## 3. Подготовка Ubuntu сервера

```bash
ssh ubuntu@91.201.215.32
sudo apt update
sudo apt install -y python3-venv python3-pip nginx redis-server
```

Путь проекта на сервере:
- `/home/ubuntu/beauty_crm`

---

## 4. Установка зависимостей на сервере

```bash
cd /home/ubuntu/beauty_crm
python3 -m venv venv
./venv/bin/pip install --upgrade pip
./venv/bin/pip install -r crm/backend/requirements.txt
./venv/bin/pip install -r site/backend/requirements.txt

ln -sfn ../../venv crm/backend/venv
ln -sfn ../../venv site/backend/venv

cd /home/ubuntu/beauty_crm/site/frontend && npm ci --include=optional
cd /home/ubuntu/beauty_crm/crm/frontend && npm ci --include=optional

mkdir -p /home/ubuntu/beauty_crm/site/backend/static/uploads
mkdir -p /home/ubuntu/beauty_crm/crm/backend/static/uploads

# Обязательно прогнать схему (идемпотентно)
cd /home/ubuntu/beauty_crm/crm/backend
RUN_MIGRATION_MAINTENANCE=false venv/bin/python -m db.migrations.run_all_migrations

cd /home/ubuntu/beauty_crm/site/backend
RUN_MIGRATION_MAINTENANCE=false venv/bin/python -m db.migrations.run_all_migrations
```

---

## 5. Сборка фронтов локально и загрузка на сервер

Собирать быстрее локально на ПК, на сервер отправлять только `dist`.

Локальная сборка:
```bash
cd /Users/tahir/Desktop/beauty-crm/site/frontend
VITE_API_URL=https://mlediamant.com npm run build

cd /Users/tahir/Desktop/beauty-crm/crm/frontend
VITE_API_URL=https://mlediamant.com/crm npm run build -- --base=/crm/
```

Загрузка `dist` на сервер:
```bash
COPYFILE_DISABLE=1 tar -C /Users/tahir/Desktop/beauty-crm/site/frontend -czf - dist \
| ssh ubuntu@91.201.215.32 'rm -rf /home/ubuntu/beauty_crm/site/frontend/dist && tar -C /home/ubuntu/beauty_crm/site/frontend -xzf -'

COPYFILE_DISABLE=1 tar -C /Users/tahir/Desktop/beauty-crm/crm/frontend -czf - dist \
| ssh ubuntu@91.201.215.32 'rm -rf /home/ubuntu/beauty_crm/crm/frontend/dist && tar -C /home/ubuntu/beauty_crm/crm/frontend -xzf -'
```

---

## 6. Systemd (два независимых сервиса)

### `/etc/systemd/system/beauty-crm-site.service`

```ini
[Unit]
Description=Beauty CRM Backend (Site runtime)
After=network.target
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/beauty_crm/site/backend
Environment="PATH=/home/ubuntu/beauty_crm/venv/bin"
Environment="PYTHONUNBUFFERED=1"
ExecStart=/home/ubuntu/beauty_crm/venv/bin/gunicorn -w 1 -k uvicorn.workers.UvicornWorker --bind 127.0.0.1:8002 --timeout 120 --graceful-timeout 30 main:app
Restart=always
RestartSec=5
KillSignal=SIGQUIT
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

### `/etc/systemd/system/beauty-crm-crm.service`

```ini
[Unit]
Description=Beauty CRM Backend (CRM runtime)
After=network.target
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=www-data
WorkingDirectory=/home/ubuntu/beauty_crm/crm/backend
Environment="PATH=/home/ubuntu/beauty_crm/venv/bin"
Environment="PYTHONUNBUFFERED=1"
ExecStart=/home/ubuntu/beauty_crm/venv/bin/gunicorn -w 1 -k uvicorn.workers.UvicornWorker --bind 127.0.0.1:8001 --timeout 120 --graceful-timeout 30 main:app
Restart=always
RestartSec=5
KillSignal=SIGQUIT
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

Активация:
```bash
sudo systemctl daemon-reload
sudo systemctl disable --now beauty_crm.service || true
sudo systemctl enable --now beauty-crm-site.service beauty-crm-crm.service
```

---

## 7. Nginx (`/etc/nginx/sites-enabled/beauty_crm.conf`)

```nginx
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

upstream crm_backend {
    server 127.0.0.1:8001;
    keepalive 32;
}

upstream site_backend {
    server 127.0.0.1:8002;
    keepalive 32;
}

server {
    listen 80;
    server_name mlediamant.com www.mlediamant.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name mlediamant.com www.mlediamant.com;

    ssl_certificate /etc/letsencrypt/live/mlediamant.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mlediamant.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml image/webp;

    client_max_body_size 50M;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    location /landing-images/ {
        alias /home/ubuntu/beauty_crm/site/frontend/src/site/public_landing/styles/img/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
        access_log off;
    }

    location ^~ /api/ws/ {
        proxy_pass http://crm_backend;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 86400;
        proxy_buffering off;
    }

    location ^~ /api/webrtc/ {
        proxy_pass http://crm_backend;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 86400;
        proxy_buffering off;
    }

    location ^~ /crm/api/ {
        rewrite ^/crm/api/?(.*)$ /api/$1 break;
        proxy_pass http://crm_backend;
    }

    location ^~ /webhook {
        proxy_pass http://crm_backend;
        proxy_read_timeout 120s;
        proxy_connect_timeout 10s;
    }

    location ^~ /proxy/ {
        proxy_pass http://crm_backend;
    }

    location ^~ /api/ {
        proxy_pass http://site_backend;
    }

    location ^~ /public/ {
        proxy_pass http://site_backend;
    }

    location = /crm {
        return 301 /crm/;
    }

    location ~* ^/crm/(.+\.(?:js|css|png|jpg|jpeg|gif|svg|webp|ico|woff2?|ttf|eot|json|webmanifest))$ {
        alias /home/ubuntu/beauty_crm/crm/frontend/dist/$1;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location /crm/ {
        alias /home/ubuntu/beauty_crm/crm/frontend/dist/;
        try_files $uri $uri/ /crm/index.html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
    }

    location ~* ^/(js|assets|fonts)/.+\.(?:js|css|woff2?|ttf|eot)$ {
        root /home/ubuntu/beauty_crm/site/frontend/dist;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* ^/(?!crm/).+\.(?:png|jpg|jpeg|gif|svg|webp|ico|txt|xml|json|webmanifest)$ {
        root /home/ubuntu/beauty_crm/site/frontend/dist;
        expires 7d;
        add_header Cache-Control "public, no-transform";
        access_log off;
    }

    location / {
        root /home/ubuntu/beauty_crm/site/frontend/dist;
        try_files $uri /index.html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate, max-age=0";
    }
}
```

Применение:
```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

## 8. Smoke-check после деплоя

```bash
# backend runtime profiles
curl -sS http://127.0.0.1:8002/api/runtime-profile
curl -sS http://127.0.0.1:8001/api/runtime-profile

# через nginx
curl -ksS -H "Host: mlediamant.com" https://127.0.0.1/api/runtime-profile
curl -ksS -H "Host: mlediamant.com" https://127.0.0.1/crm/api/runtime-profile
```

Должно быть:
- `/api/runtime-profile` -> `site`
- `/crm/api/runtime-profile` -> `crm`

---

## 9. Почему одновременный запуск не тормозит

- В проде не запускается Vite-dev-server, только статические файлы через nginx.
- `site` и `crm` backend работают отдельными процессами и не блокируют друг друга по релизам.
- На сервере с 1 vCPU оптимально по `1 worker` на runtime (как в service-файлах выше).
- Можно перезапускать/откатывать `site` и `crm` отдельно.

---

## 10. Обязательное правило синхронизации

Если на сервере найдена ошибка и фикс сделан в коде, тот же фикс сразу вносится в локальный репозиторий (`/Users/tahir/Desktop/beauty-crm`) и только после этого выкатывается на сервер.
