# Полная инструкция деплоя Beauty CRM (split: site + crm)

## 1) Очистить сервер и залить свежий код

```bash
ssh ubuntu@91.201.215.32
# 1. Перейти в папку проекта (если вы не в ней)
cd /home/ubuntu/beauty_crm

# 2. Удалить всё содержимое
rm -rf ./*

# 3. ВЫЙТИ ИЗ СЕРВЕРА (обязательно, чтобы вернуться на Mac)
exit
```

После того как вы вышли (`exit`), выполните на Mac:

```bash
# 4. Заливка файлов с Mac на сервер
rsync -avz --progress \
  --exclude 'venv' \
  --exclude 'node_modules' \
  --exclude '.git' \
  --exclude '__pycache__' \
  --exclude 'site/backend/static' \
  --exclude 'crm/backend/static' \
  ~/Desktop/beauty-crm/ ubuntu@91.201.215.32:/home/ubuntu/beauty_crm/
```

## 2) Установка backend зависимостей на сервере (оба контура)

Подключитесь на сервер снова:

```bash
ssh ubuntu@91.201.215.32
```

CRM backend:

```bash
cd /home/ubuntu/beauty_crm/crm/backend
rm -rf venv
which python3
which python
unalias python
unalias pip
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 -m pip install --upgrade pip
python3 -m uvicorn main:app --reload
```

Или короткая версия:

```bash
cd /home/ubuntu/beauty_crm/crm/backend
source venv/bin/activate
python3 -m uvicorn main:app --reload
```

Site backend:

```bash
cd /home/ubuntu/beauty_crm/site/backend
rm -rf venv
which python3
which python
unalias python
unalias pip
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 -m pip install --upgrade pip
python3 -m uvicorn main:app --reload
```

Или короткая версия:

```bash
cd /home/ubuntu/beauty_crm/site/backend
source venv/bin/activate
python3 -m uvicorn main:app --reload
```

## 3) Установка frontend зависимостей на сервере (оба контура)

CRM frontend (из `crm/backend`):

```bash
cd ..
cd frontend
npm cache clean --force
npm install --no-audit --prefer-offline --verbose
```

Site frontend (из `site/backend`):

```bash
cd ..
cd frontend
npm cache clean --force
npm install --no-audit --prefer-offline --verbose
```

## 4) Перезапуск сервисов на сервере

```bash
sudo systemctl daemon-reload
sudo systemctl restart beauty-crm-crm
sudo systemctl restart beauty-crm-site
sudo systemctl restart nginx
sudo journalctl -u beauty-crm-crm -f
```

Если нужен лог site runtime:

```bash
sudo journalctl -u beauty-crm-site -f
```

Legacy (если у вас пока один unit `beauty_crm`):

```bash
sudo systemctl daemon-reload
sudo systemctl restart beauty_crm
sudo systemctl restart nginx
sudo journalctl -u beauty_crm -f
```

## 5) Локальный запуск CRM

Backend, полная переустановка:

```bash
cd /Users/tahir/Desktop/beauty-crm/crm/backend
rm -rf venv
which python3
which python
unalias python
unalias pip
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 -m pip install --upgrade pip
python3 -m uvicorn main:app --reload
```

Или короткая версия:

```bash
cd /Users/tahir/Desktop/beauty-crm/crm/backend
source venv/bin/activate
python3 -m uvicorn main:app --reload
```

Frontend, полная переустановка:

```bash
cd ..
cd frontend
rm -rf node_modules package-lock.json dist
npm cache clean --force
echo "registry=https://registry.npmjs.org/
audit=false
fund=false
loglevel=warn" > .npmrc
npm install --no-audit --prefer-offline --verbose
npm run build
npm run dev
```

Или короткая версия:

```bash
cd /Users/tahir/Desktop/beauty-crm/crm/frontend
npm run dev
```

## 6) Локальный запуск Site (public/account/admin)

Backend, полная переустановка:

```bash
cd /Users/tahir/Desktop/beauty-crm/site/backend
rm -rf venv
which python3
which python
unalias python
unalias pip
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 -m pip install --upgrade pip
python3 -m uvicorn main:app --reload
```

Или короткая версия:

```bash
cd /Users/tahir/Desktop/beauty-crm/site/backend
source venv/bin/activate
python3 -m uvicorn main:app --reload
```

Frontend, полная переустановка:

```bash
cd ..
cd frontend
rm -rf node_modules package-lock.json dist
npm cache clean --force
echo "registry=https://registry.npmjs.org/
audit=false
fund=false
loglevel=warn" > .npmrc
npm install --no-audit --prefer-offline --verbose
npm run build
npm run dev
```

Или короткая версия:

```bash
cd /Users/tahir/Desktop/beauty-crm/site/frontend
npm run dev
```

## 7) Одновременный запуск локально

Нужны 4 процесса:

1. `/Users/tahir/Desktop/beauty-crm/site/backend` -> `python3 -m uvicorn main:app --reload`
2. `/Users/tahir/Desktop/beauty-crm/site/frontend` -> `npm run dev`
3. `/Users/tahir/Desktop/beauty-crm/crm/backend` -> `python3 -m uvicorn main:app --reload`
4. `/Users/tahir/Desktop/beauty-crm/crm/frontend` -> `npm run dev`

Переход между контурами:

- Site: `https://mlediamant.com/`
- CRM: `https://mlediamant.com/crm/`
