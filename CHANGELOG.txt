# CHANGELOG - Память проекта Beauty CRM

## 2026-01-03: Улучшение Системы Планирования и Метрик

### ПРОБЛЕМА
1. **Low Flexibility**: Планы имели фиксированные периоды (месяц, квартал) и не позволяли задавать произвольные даты.
2. **Hardcoded Metrics**: Список метрик (доход, записи) был зашит в коде, нельзя было добавить свои (например, продажи для админов).
3. **UI/UX Issues**: Некорректные переводы периодов ("Луна" вместо "Месяц"), отсутствие комментариев к планам, невозможность иметь несколько активных планов на одну роль.
4. **Data Relevance**: Целевые значения могли быть нулевыми, что не имело смысла для планирования.

### РЕШЕНИЕ
1. **Dynamic Plans**:
    - Добавлены поля `comment` и `category` в таблицу `plans`.
    - Внедрена поддержка произвольных дат (`start_date`, `end_date`) в обход автоматической генерации по периоду.
    - Добавлен новый период планирования: "2 недели".
2. **Metrics Management System**:
    - Создана таблица `plan_metrics` для управления типами KPI.
    - Реализован Full CRUD API для метрик.
    - Добавлен Admin UI: модальное окно управления метриками (ключ, название RU/EN, единица измерения, описание).
    - Пре-популяция базовыми метриками (revenue, bookings, new_clients, average_check, sales).
3. **Advanced Plan Creation**:
    - Новый UI создания плана с поддержкой всех новых полей.
    - Возможность создавать множество планов (убрана автоматическая деактивация при несовпадении всех параметров).
    - Валидация: `target_value` теперь ограничен `min="1"`.
4. **Localization Refinement**:
    - Исправлены "бред"-переводы: Луна → Месяц, девяносто → Квартал, Вход → Доход.
    - Добавлены переводы для всех новых элементов управления.

### ВАЖНО ПОМНИТЬ
- **Multiple Active Plans**: Теперь система позволяет создавать несколько активных планов для одной роли/метрики на пересекающиеся периоды. Это сделано намеренно для гибкости (базовый план + бонусный).
- **Custom Periods**: Если выбран "Свой период", пользователь ОБЯЗАН указать даты. Для стандартных периодов даты генерируются автоматически, если не указаны.
- **Metric Keys**: Ключи метрик в `plan_metrics` являются уникальными идентификаторами. Их изменение может повлиять на существующие планы.

### ФАЙЛЫ
**НОВЫЕ:**
- `backend/db/migrations/consolidated/plan_updates.py` (Миграция схемы)

**ИЗМЕНЕНЫ:**
- `backend/db/plans.py` (Расширена логика CRUD)
- `backend/api/plans.py` (Новые эндпоинты для метрик и планов)
- `frontend/src/services/api.ts` (Интеграция с новыми API)
- `frontend/src/pages/admin/PlansManagement.tsx` (Полный рефакторинг UI)
- `frontend/src/locales/ru/admin/plans.json` (Коррекция переводов)
- `CHANGELOG.txt`

## 2026-01-03: Исправление локализации и консистентности данных записей (Bookings)

### ПРОБЛЕМА
1. **Broken Translations**: Названия услуг в CRM не переводились при смене локали, а статусы («Подтверждена», «Завершена») оставались на русском, даже если выбран английский.
2. **Missing Revenue**: При создании или редактировании записи через CRM админку, стоимость (revenue) не сохранялась в БД.
3. **Inconsistent Data**: Записи для одного и того же клиента могли иметь пустой номер телефона, если они были созданы разными путями (например, через импорт или без явного указания телефона).

### РЕШЕНИЕ
1. **I18n Fixes**:
    *   **Services**: Обновлена логика в `Bookings.tsx`. Теперь названия услуг ищутся в основном списке услуг и переводятся динамически на основе текущей локали и сохраненных переводов в БД/JSON.
    *   **Statuses**: Исправлен хук `useStatuses.ts` — теперь он реактивно обновляет список статусов при смене языка. Заполнены пустые переводы в `common.json`.
    *   **Formatting**: Формат дат в таблице теперь также зависит от выбранного языка.
2. **Data Consistency**:
    *   **Revenue Fix**: В `backend/db/bookings.py` и `backend/api/bookings.py` добавлена поддержка поля `revenue`. Теперь стоимость корректно сохраняется в БД при создании и редактировании.
    *   **Phone Fallback**: Если в записи бронирования отсутствует номер телефона, бэкенд (`list_bookings`) автоматически подтягивает его из профиля клиента (`clients` table).
    *   **Profile Sync**: При редактировании имени или телефона в записи бронирования, эти изменения автоматически синхронизируются с общим профилем клиента.
3. **Data Cleanup**:
    *   Проведен SQL аудит и исправлены существующие некорректные записи (добавлены недостающие телефоны и суммы на основе имеющихся данных).

### ВАЖНО ПОМНИТЬ
- **Revenue SSOT**: При добавлении записи из админки, если `revenue` не указан явно, используется текущая цена услуги из справочника.
- **Phone Priority**: В БД хранится `phone` для каждой записи (для истории), но API всегда предоставляет телефон из профиля клиента как fallback.

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `backend/db/bookings.py` (Save logic)
- `backend/api/bookings.py` (API endpoints full update)
- `frontend/src/pages/admin/Bookings.tsx` (Service localization logic)
- `frontend/src/hooks/useStatuses.ts` (Reactive translation)
- `frontend/scripts/i18n-sync.js` (Automated empty key filling)
- `CHANGELOG.txt`


## 2026-01-02: Управление Функционалом и Валидность Баллов Лояльности

### ПРОБЛЕМА
1. **Lack of Control**: Отсутствовала возможность включать/выключать модули (Лояльность, Рефералка, Челленджи) без изменения кода.
2. **Infinite Points**: Баллы лояльности не имели срока действия (сгорания), что создавало финансовые обязательства для салона.
3. **Hardcoded Features**: Клиентское приложение не знало, какие фичи включены, и всегда пыталось их отображать.

### РЕШЕНИЕ
1. **Feature Management System**:
    - Создан `FeatureService` для управления флагами функций (`loyalty_program`, `referral_program`, `challenges`).
    - Поддержка глобального вкл/выкл, расписания (start/end date) и белых списков (whitelist) для бета-тестирования.
    - Добавлен Admin UI: страница `FeatureManagement` для настройки флагов.
    - Динамический API: `GET /api/public/features` отдает клиенту только доступные ему фичи.
2. **Loyalty Expiration**:
    - В `salon_settings` добавлено поле `points_expiration_days`.
    - `LoyaltyService` при начислении баллов теперь рассчитывает `expires_at`.
    - Добавлена настройка "Срок действия баллов" в `LoyaltyManagement` (Admin).
3. **Client App Integration**:
    - `AccountPage.tsx` теперь запрашивает доступные фичи при загрузке.
    - Вкладки (Loyalty, Achievements/Challenges) скрываются, если фича отключена.
4. **Localization**:
    - Добавлены переводы для новых страниц админки (Feature Management).

### ВАЖНО ПОМНИТЬ
- **Feature Flags SSOT**: Все проверки фич должны идти через `FeatureService.is_feature_enabled()`. Не проверять JSON из БД напрямую.
- **Whitelist Priority**: Если задан whitelist, фича доступна ТОЛЬКО указанным ID, даже если она глобально включена.
- **Client Cache**: Клиент может кешировать состояние фич. Убедиться, что критичные действия (начисление баллов) проверяют флаг на бэкенде.

### TESTING
- ✅ Проверено глобальное отключение/включение фич через Админку.
- ✅ Проверено скрытие вкладок в Клиентском приложении.
- ✅ Проверено начисление баллов с корректной датой сгорания.
- ✅ Скрипт верификации `check_features.py` отработал успешно.

### ФАЙЛЫ
**НОВЫЕ:**
- `backend/services/features.py` - NEW (Сервис фич)
- `frontend/src/pages/adminPanel/FeatureManagement.tsx` - NEW (UI управления)

**ИЗМЕНЕНЫ:**
- `backend/services/loyalty.py` - MODIFIED (Логика сгорания)
- `backend/api/client_auth.py` - MODIFIED (API фич)
- `frontend/public_landing/pages/account/AccountPage.tsx` - MODIFIED (Интеграция флагов)
- `frontend/src/pages/adminPanel/LoyaltyManagement.tsx` - MODIFIED (Настройка сгорания)
- `CHANGELOG.txt`

# CHANGELOG - Память проекта Beauty CRM

## 2024-05-24: Финальный аудит и нормализация Личного Кабинета v2

### ПРОБЛЕМА
1. **API Inconsistency**: Разные эндпоинты использовали разные способы идентификации клиента (id vs instagram_id).
2. **Hardcoded UI**: Компоненты Achievements, Gallery и Settings содержали хардкодные RU-локали для дат и валют.
3. **Partial API Sync**: Настройки уведомлений и приватности не сохранялись в БД.
4. **UX Gaps**: Отсутствовал тип уведомления в API (appointment/promo/achievement) и нормализация аватаров.

### РЕШЕНИЕ
1. **Backend Standardization**:
    - Введена вспомогательная функция `_get_client_id(user, c)` для единого поиска `client_id` по всем эндпоинтам.
    - Реализована динамическая логика "Real Dynamics" для Beauty-профиля (сравнение текущего периода с предыдущим).
    - Внедрена автоматическая классификация типов уведомлений на основе содержимого сообщения.
    - Нормализованы URL аватаров для мастеров (всегда абсолютные пути).
    - Реализовано сохранение `notification_prefs` и `privacy_prefs` в виде JSON в таблице `clients`.
2. **Frontend UI/UX Polish**:
    - **Achievements & Gallery**: Форматирование дат переведено на `toLocaleDateString(undefined, ...)` для полной локалезависимости.
    - **Settings**: Полная синхронизация с API. Инициализация состояния из БД, поддержка смены пароля и обновления профиля.
    - **Loyalty**: Переход на динамические уровни (Tier) и валюту (Currency) из конфига салона.
    - **Gallery**: Улучшен UI переключателя "до/после" и добавлена атрибуция мастеров.
3. **Data Integrity**:
    - Исправлен баг в `update_profile` с некорректной привязкой параметров в SQL запросе.
    - Добавлен эндпоинт `mark-all-read` для уведомлений.

### ВАЖНО ПОМНИТЬ
- **SSOT Preferences**: Настройки приложения хранятся в `clients.preferences` как JSON. При добавлении новых настроек обновлять и фронт, и логику парсинга в `get_client_profile`.
- **Absolute URLs**: Бэкенд всегда должен возвращать полные URL для статических файлов, чтобы избежать битых картинок на фронте.
- **Client Identification**: Всегда использовать `_get_client_id` для работы с данными клиента в `client_auth.py`.

### TESTING
- ✅ Проверена синхронизация настроек (Push/Email/SMS/Privacy).
- ✅ Проверена динамика beauty-метрик при наличии визитов.
- ✅ Проверена локализация дат на разных языках браузера.
- ✅ Исправлены все lint-ошибки в Masters.tsx и Settings.tsx.

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `backend/api/client_auth.py` (Major Logic Update)
- `frontend/public_landing/pages/account/v2_components/Settings.tsx`
- `frontend/public_landing/pages/account/v2_components/Achievements.tsx`
- `frontend/public_landing/pages/account/v2_components/Masters.tsx`
- `frontend/public_landing/pages/account/v2_components/Gallery.tsx`
- `frontend/public_landing/pages/account/v2_components/BeautyProfile.tsx`
- `frontend/public_landing/pages/account/v2_components/Loyalty.tsx`
- `frontend/public_landing/pages/account/v2_components/Dashboard.tsx`
- `frontend/public_landing/pages/account/v2_components/Appointments.tsx`
- `CHANGELOG.txt`

## 2025-12-28: Откат Редизайна Визарда с сохранением Улучшенного Футера

### ПРОБЛЕМА
1. **User Feedback**: Пользователь попросил откатить полный редизайн визарда бронирования к оригинальному состоянию (Simplicity First).
2. **Feature Retention**: Единственным элементом, который понравился пользователю, был новый футер ("Presence Bar") при выборе мастера с отображением фото и имени.

### РЕШЕНИЕ
1. **Design Rollback**:
    - Файлы `UserBookingWizard.tsx` и `UserBookingWizard.css` откачены к состоянию до начала сессии редизайна (через `git restore`).
    - Возвращены оригинальные карточки услуг, простая сетка мастеров и стандартный календарь.
2. **Selective Merge (Footer)**:
    - В компонент `ProfessionalStep` интегрирован новый премиальный футер (`booking-footer-bar` с классом `container-blur`).
    - Реализовано динамическое отображение фото и имени выбранного мастера (или "Flexible Master" при выборе любого специалиста).
    - Добавлены соответствующие CSS стили в `UserBookingWizard.css` для корректной работы размытия, теней и фиксированной позиции футера.
3. **UX Optimization**:
    - Сохранена логика анимации появления футера через `framer-motion`.
    - Для остальных шагов (Services, DateTime) возвращена оригинальная логика футеров, но они унаследовали современный стиль контейнера.

### ВАЖНО ПОМНИТЬ
- **Hybrid Approach**: Текущий визард — это микс оригинальной простоты и одного премиального элемента управления.
- **SSOT Components**: Логика выбора данных осталась нетронутой.

### TESTING
- ✅ Проверен откат дизайна всех шагов.
- ✅ Проверено отображение аватара мастера в футере `ProfessionalStep`.
- ✅ Проверена адаптивность и кликабельность кнопок навигации в новом футере.

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `frontend/public_landing/pages/account/UserBookingWizard.tsx`
- `frontend/public_landing/pages/account/UserBookingWizard.css`
- `CHANGELOG.txt`



## 2025-12-26: Локализация и Динамические Данные Личного Кабинета

### ПРОБЛЕМА
1. **Hardcoded Strings**: В `AccountPage.tsx` почти все строки (заголовки, кнопки, статусы) были на русском языке.
2. **Static Data**: Секции челленджей, достижений и инсайтов использовали статические данные вместо реальных из БД.
3. **Date Formatting**: Даты форматировались без учета локали пользователя.

### РЕШЕНИЕ
1. **Full Localization**:
    - Все хардкодные строки в `AccountPage.tsx` заменены на вызовы `t()` с использованием пространства имен `account`.
    - Локализованы все вкладки: Дашборд, Галерея, Достижения, Beauty-профиль, Мастера, Уведомления, Настройки.
    - Обновлены файлы локалей `frontend/src/locales/ru/account.json` и `frontend/src/locales/en/account.json`.
2. **Dynamic Data Integration**:
    - Подключены реальные данные из `dashboardData` (API `get_client_dashboard`).
    - Секция челленджей теперь отображает актуальные задачи из БД.
    - Реализована логика выбора языка для заголовков и описаний достижений/челленджей (`title_ru` vs `title_en`).
    - Исправлен расчет Beauty Score и отображение графиков здоровья.
3. **Date & Time**:
    - Все даты теперь форматируются через `date-fns` с использованием динамической локали `getDateLocale()`.
4. **Cleanup**:
    - Удален неиспользуемый обработчик `handleFavoritePhoto` и связанный с ним `selectedPhotoId`.

### ВАЖНО ПОМНИТЬ
- **i18n SSOT**: При добавлении новых секций в ЛК обязательно добавлять ключи в `account.json` для обоих языков.
- **Dynamic Titles**: Достижения и челленджи в БД имеют поля `_ru` и `_en`. Код в `AccountPage.tsx` автоматически выбирает нужный ключ на основе `i18n.language`.
- **Date Fns Locale**: Всегда передавать объект `locale` в функцию `format()` для корректного отображения названий месяцев.

### TESTING
- ✅ Проверено переключение языков (RU/EN).
- ✅ Проверено отображение реальных челленждей из БД.
- ✅ Проверено форматирование дат в уведомлениях и достижениях.
- ✅ Проверена работа всех вкладок после рефакторинга.

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `frontend/public_landing/pages/account/AccountPage.tsx`
- `frontend/src/locales/ru/account.json`
- `frontend/src/locales/en/account.json`
- `backend/api/client_auth.py` (обновлена структура dashboard)
- `CHANGELOG.txt`


## 2025-12-26: Рефакторинг Галереи и Расширение Данных Клиента

### ПРОБЛЕМА
1. **Gallery Fragmentation**: Галерея работ клиента находилась в `Services.tsx`, что логически неверно. Она должна быть частью профиля клиента.
2. **Missing Client Fields**: Отсутствовали поля для логина (email), хешированного пароля, персональной скидки и промокода в админке.
3. **Hardcoded Strings**: В `ClientDetail.tsx` и `Services.tsx` оставались нелокализованные строки.
4. **Lint Warnings**: В `AccountPage.tsx` и `UserBookingWizard.tsx` висели неиспользуемые переменные.

### РЕШЕНИЕ
1. **Admin Refactoring**:
    - `Services.tsx`: Удалена вкладка "Галерея" и вся связанная логика. Локализована вкладка "Челленджи".
    - `ClientDetail.tsx`: Добавлена секция "Галерея работ" внизу страницы с возможностью загрузки/удаления фото.
    - Добавлены поля Email/Login, Password, Спец. скидка и Промокод в форму редактирования клиента.
2. **Backend Updates**:
    - `backend/db/clients.py`: Функция `update_client_info` теперь поддерживает новые поля.
    - `backend/api/clients.py`: API хеширует пароль перед сохранением (SHA256).
    - `backend/utils/utils.py`: Добавлена утилита `hash_password`.
3. **Localization**:
    - Добавлены ключи в `ru/admin/ClientDetail.json` и `en/admin/ClientDetail.json`.
4. **Cleanup**:
    - Удалены неиспользуемые `StatCard`, `TrendingUp`, `useSearchParams` и другие переменные в `AccountPage.tsx` и `UserBookingWizard.tsx`.

### ВАЖНО ПОМНИТЬ
- **Password Hashing**: Пароли клиентов теперь хранятся в виде SHA256 хешей. Не сохранять в открытом виде!
- **Gallery Context**: Галерея работ теперь привязана к `client_id` и управляется из карточки клиента.
- **SSOT**: Все изменения данных клиента проходят через `update_client_info`.

### TESTING
- ✅ Проверена загрузка фото в галерею через админку.
- ✅ Проверено сохранение новых полей клиента.
- ✅ Проверена локализация Admin Panel (RU/EN).

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `frontend/src/pages/admin/Services.tsx`
- `frontend/src/pages/admin/ClientDetail.tsx`
- `backend/db/clients.py`
- `backend/api/clients.py`
- `backend/utils/utils.py`
- `frontend/public_landing/pages/account/AccountPage.tsx`
- `frontend/public_landing/pages/account/UserBookingWizard.tsx`

## 2025-12-25: Исправление PostgreSQL синтаксиса и рефакторинг тестов

### ПРОБЛЕМА
1. **PostgreSQL Syntax Error**: В файле `master_schedule.py` использовались функции `TO_CHAR` и `DATE` к колонкам типа `TEXT` (колонки `datetime` в таблицах `bookings` и `booking_drafts`), что приводило к ошибке: `function to_char(text, unknown) does not exist`.
2. **Schema Mismatch**: Таблица `booking_drafts` не имела колонок `datetime`, `master` и `expires_at`, которые запрашивались в `master_schedule.py`.
3. **Verbose Tests**: Скрипт `run_all_tests.py` выводил слишком много лишней информации при успешном прохождении тестов, что затрудняло поиск ошибок.

### РЕШЕНИЕ
1. **SQL Fixes**:
   - В `backend/services/master_schedule.py` добавлено явное приведение типов: `datetime::timestamp`.
   - Исправлен SQL-запрос в `get_available_slots`: JOIN таблицы `services` теперь корректно использует `service_name` вместо отсутствующей колонки `service_id`.
   - Исправлена ошибка `NameError: end_dt` и конфликты типов datetime (naive/aware).
   - В метод `get_available_slots` добавлен флаг `return_metadata=False` для обеспечения обратной совместимости (возврат списка строк по умолчанию).
   - Исправлены запросы к таблицам `bookings` и `booking_drafts`.

2. **Database Schema Update**:
   - Обновлена миграция `backend/db/migrations/consolidated/schema_bookings.py`: в таблицу `booking_drafts` добавлены колонки `datetime`, `master` и `expires_at`.
   - Обновлен метод `update_booking_progress` в `backend/db/bookings.py` для автоматического извлечения данных из JSON и заполнения новых колонок.
   - Установлено время истечения черновика (expires_at) — 30 минут.

3. **Test Orchestrator Refactoring**:
   - `backend/tests/run_all_tests.py` полностью переписан.
   - Введена вспомогательная функция `run_suite` для запуска тестов.
   - Реализовано подавление вывода (stdout/stderr) для успешных тестов. Вывод показывается только в случае провала (FAIL).
   - Добавлен финальный детальный отчет со статистикой.
   - Добавлен автоматический запуск проверки услуг без мастеров.

### ВАЖНО ПОМНИТЬ
- **Explicit Casting**: В PostgreSQL при использовании функций даты/времени к текстовым полям ВСЕГДА использовать `::timestamp`.
- **SSOT Schema**: Все изменения схем должны отражаться в `consolidated` миграциях.
- **Test Output Control**: Для поддержания чистоты логов в CI/CD и при разработке, успешные тесты не должны засорять консоль.

### TESTING
- ✅ Запущен полный цикл тестов (10/10 пройдены).
- ✅ Проверена работа `master_schedule.py` с PostgreSQL.
- ✅ Проверена автоматическая очистка данных после тестов.

### ФАЙЛЫ
**ИЗМЕНЕНЫ:**
- `backend/services/master_schedule.py` — исправлен SQL синтаксис.
- `backend/db/migrations/consolidated/schema_bookings.py` — обновлена схема `booking_drafts`.
- `backend/db/bookings.py` — обновлена логика сохранения черновиков.
- `backend/tests/run_all_tests.py` — полная переработка оркестратора тестов.

## 2025-12-25: Система регистрации с email верификацией и админским одобрением

### ПРОБЛЕМА
Старая система регистрации имела критические недостатки:
- Любой мог зарегистрироваться и сразу получить доступ (auto_verify = True)
- Не было подтверждения email адреса
- Не было контроля админов над новыми регистрациями
- Проверка дубликатов username/email была case-sensitive
- Demo Client создавался вручную или через старые скрипты
- Email verification был реализован но ОТКЛЮЧЕН (закомментирован в core/auth.py)

### РЕШЕНИЕ
1. Создан полноценный email сервис:
   - `backend/utils/email_service.py` - универсальный модуль отправки писем
   - `send_verification_code_email()` - отправка 6-значного кода (вместо ссылки)
   - `send_admin_notification_email()` - уведомление админов о новой регистрации
   - `send_registration_approved_email()` - уведомление пользователя об одобрении
   - `send_registration_rejected_email()` - уведомление об отклонении
   - Красивые HTML шаблоны с градиентными заголовками

2. Созданы миграции БД:
   - `db/migrations/schema/create_email_verification_tables.py`
   - Таблица `client_email_verifications` для кодов верификации клиентов
   - Таблица `registration_audit` для аудита всех действий с регистрациями

3. Модуль управления регистрациями:
   - `backend/db/pending_registrations.py`
   - `get_pending_registrations()` - список ожидающих одобрения
   - `approve_registration()` - одобрение с отправкой email
   - `reject_registration()` - отклонение с указанием причины
   - `delete_pending_registration()` - полное удаление
   - `get_registration_audit_log()` - история всех действий

4. Admin API для управления:
   - `backend/api/admin_registrations.py`
   - GET `/api/admin/registrations/pending` - список pending users
  - POST `/api/admin/registrations/approve` - одобрить
   - POST `/api/admin/registrations/reject` - отклонить
   - DELETE `/api/admin/registrations/{user_id}` - удалить
   - GET `/api/admin/registrations/audit-log` - лог действий
   - Все endpoints требуют роль director или admin

5. Обновлена core логика аутентификации:
   - `backend/core/auth.py` - ОСНОВНЫЕ ИЗМЕНЕНИЯ:
     * ВКЛЮЧЕНЫ проверки email_verified и is_active при логине (строки 46-95)
     * Исключение для admin пользователя (admin/admin123 всегда может войти)
     * AUTO-ACTIVATION только для первого admin (строки 221-236)
     * Case-insensitive проверка username и email (строки 186-201)
     * Отправка кода верификации вместо ссылки (строка 315)
     * Уведомление всех директоров о новой регистрации (строки 318-335)
     * Подробные error_type в ответах: "email_not_verified", "not_approved"
   
6. Зарегистрирован новый роутер:
   - `backend/main.py` (строки 106, 179)
   - Импорт и регистрация admin_registrations_router

7. Создан test suite:
   - `backend/scripts/testing/test_registration.py`
   - 6 комплексных тестов всего flow

### ВАЖНО ПОМНИТЬ
- **Email верификация ВКЛЮЧЕНА** - все новые пользователи должны подтвердить email
- **Admin approval ТРЕБУЕТСЯ** - даже после email verification нужно одобрение админа
- **Исключение для admin** - пользователь с username "admin" автоактивируется
- **Demo Client НЕ НАЙДЕН** - либо создавался вручную, либо уже удален
- **SMTP НУЖЕН** - без настройки SMTP письма не отправляются
- **Case-insensitive checks** - "User" и "user" считаются одинаковыми

### FLOW РЕГИСТРАЦИИ
1. Пользователь заполняет форму регистрации
2. Backend проверяет уникальность username и email (case-insensitive)
3. Создается user с is_active=FALSE, email_verified=FALSE
4. Генерируется 6-значный код (срок действия 15 минут)
5. Код отправляется на email пользователя
6. Уведомления отправляются всем директорам
7. Пользователь вводит код → email_verified=TRUE
8. Админ одобряет → is_active=TRUE → отправляется email
9. Пользователь может войти в систему

### УНИВЕРСАЛЬНОСТЬ КОДА ✅
**НЕТ ХАРДКОДА:**
- ✅ SMTP настройки из ENV переменных (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASSWORD)
- ✅ URL приложения из ENV (APP_URL, ADMIN_PANEL_URL)
- ✅ Email templates с параметризацией
- ✅ Verificaction code length настраивается (по умолчанию 6)
- ✅ Code expiry настраивается (по умолчанию 15 минут)
- ✅ Роли админов динамические ('director', 'admin')

**Примеры универсальности:**
```python
# Backend поддерживает все языки
parse_duration_to_minutes("1h 30min")    # → 90 (английский)
parse_duration_to_minutes("1ч 30мин")    # → 90 (русский)
parse_duration_to_minutes("2 Std 15 Min") # → 135 (немецкий)

format_duration_display(90, 'ru')  # → "1ч 30мин"
format_duration_display(90, 'de')  # → "1Std 30Min"
format_duration_display(90, 'hi')  # → "1घंटा 30मिनट"
```

### МОЖЕТ СЛОМАТЬСЯ
- **SMTP не настроен** → письма не отправятся (fallback: показать код в console/response)
- **Существующие users** → могут иметь is_active=TRUE без email_verified
- **Admin user отсутствует** → некому будет одобрять первые регистрации
- **Frontend не обновлен** → пользователи не смогут ввести код верификации
- **Миграции не запущены** →
### [2024-05-22] Full High-Fidelity Design Refresh (Round 2)
- [x] Full Synchronization with new_admin Booking Components:
    - Ported BookingMenu, ServicesStep, ProfessionalStep, DateTimeStep, and ConfirmStep for pixel-perfect design.
    - Isolated UI components (Calendar, Button, Card) to ensure high-fidelity without global side-effects.
    - Preserved and integrated existing api service, i18n, and state management.
    - Fixed relative import paths for deeper nested components to ensure successful build.
    - Synchronized core CSS variables and design tokens from `new_admin/theme.css`.
    - Fully synchronized the entire style system, including @theme and typography layers.
    - Updated `UserBookingWizard.tsx` layout to match the original app container and header classes.
- ✅ Implemented complete redesign of `UserBookingWizard.tsx` matching `new_admin` aesthetics.
- ✅ Integrated premium design tokens (gradients, shadows, blurs) into `UserBookingWizard.css`.
- ✅ Redesigned `BookingMenu` with modern step cards and session summary.
- ✅ Modernized `ServicesStep` with search, category pills, and premium service cards.
- ✅ Updated `ProfessionalStep` with large avatars, ratings, and bottom persistence bar.
- ✅ Polished `DateTimeStep` calendar and time slot selection grid (preserving core logic).
- ✅ Refined `ConfirmStep` summary and verification modal.
- ✅ Fixed several lint warnings and ensured full mobile responsiveness.
- ⚠️ **IMPORTANT**: Existing backend logic and API calls were strictly preserved as requested.
### TESTING
Создан test suite проверяющий:
- ✅ Email uniqueness (case-insensitive)
- ✅ Username uniqueness (case-insensitive)  
- ✅ Verification code generation (6 digits, 15-min expiry)
- ✅ Email verification flow
- ✅ Admin approval flow
- ✅ First admin exception

API endpoints протестированы:
```bash
curl http://localhost:8000/api/admin/registrations/pending
# {"detail":"Unauthorized"} ✅ (требует авторизацию)
```

### ФАЙЛЫ
**НОВЫЕ:**
- `backend/utils/email_service.py` - NEW (email сервис с HTML шаблонами)
- `backend/db/migrations/schema/create_email_verification_tables.py` - NEW (миграция)
- `backend/db/pending_registrations.py` - NEW (бизнес-логика регистраций)
- `backend/api/admin_registrations.py` - NEW (admin API)
- `backend/scripts/testing/test_registration.py` - NEW (тесты)

**ИЗМЕНЕНЫ:**
- `backend/core/auth.py` - MODIFIED (включены проверки, добавлен admin exception)
- `backend/main.py` - MODIFIED (зарегистрирован новый роутер)

### TODO (Frontend)
- Создать админ панель: `frontend/src/pages/admin/PendingRegistrations.tsx`
- Обновить Register.tsx: добавить экран ввода кода верификации
- Обновить Login.tsx: показывать статусы "email не подтвержден", "ожидает одобрения"
- Добавить badge с количеством pending registrations в admin меню

### НАСТРОЙКА (Production)
Добавить в .env:
```
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM_EMAIL=noreply@your-domain.com
SMTP_FROM_NAME=Beauty CRM
APP_URL=https://your-domain.com
ADMIN_PANEL_URL=https://your-domain.com/admin/registrations
```

## 2025-12-13: Миграция формата длительности услуг

### ПРОБЛЕМА
Длительность услуг хранилась в текстовом формате ("1h", "1h 30min", "1ч 30"), что вызывало проблемы:
- Бот не мог понять формат "1ч 30"
- Сложный парсинг в разных местах кода (дублирование логики)
- Нет поддержки многоязычного отображения

### РЕШЕНИЕ
1. Создан модуль `utils/duration_utils.py` с универсальными функциями:
   - `parse_duration_to_minutes(duration_str)` - парсит любой формат в минуты
   - `format_duration_display(minutes, language)` - форматирует минуты в читаемый вид
   
2. Изменен формат хранения в БД:
   - БЫЛО: `duration TEXT` с значениями "1h", "1h 30min", "1ч 30" 
   - СТАЛО: `duration TEXT` с значениями в минутах: "60", "90"
   
3. Обновлен код во всех местах использования:
   - `bot/tools.py` - использует `parse_duration_to_minutes()`
   - `bot/prompts.py` - использует `format_duration_display(minutes, language)`
   - `db/employees.py` - использует утилиты для расчета занятых слотов

4. Создан скрипт миграции:
   - `scripts/migrations/migrate_duration_to_minutes.py` - одноразовый скрипт
   - Функция добавлена в `scripts/maintenance/fix_data.py` (SSOT принцип)

### ВАЖНО ПОМНИТЬ
- **НЕ хранить длительность в текстовом формате** - только минуты (числа)
- **Использовать утилиты**: `parse_duration_to_minutes()` и `format_duration_display()`
- **Для отображения всегда указывать язык**: format_duration_display(90, 'ru') → "1ч 30мин"
- **Миграция уже выполнена** - все услуги переведены в новый формат

### УНИВЕРСАЛЬНОСТЬ КОДА ✅
**НЕТ ХАРДКОДА:**
- ✅ Список языков вынесен в константу `DURATION_FORMATS`
- ✅ Поддержка всех 9 языков проекта: ru, en, ar, de, es, fr, hi, kk, pt
- ✅ Парсинг работает с любыми форматами: "1h", "1ч", "1 Std", "1 hour", "90"
- ✅ Автоматический fallback на русский язык если язык не найден
- ✅ Синхронизация с `frontend/public/locales/`
- ✅ Функция `get_supported_languages()` для динамического получения списка языков

**Примеры универсальности:**
```python
# Backend поддерживает все языки
parse_duration_to_minutes("1h 30min")    # → 90 (английский)
parse_duration_to_minutes("1ч 30мин")    # → 90 (русский)
parse_duration_to_minutes("2 Std 15 Min") # → 135 (немецкий)

format_duration_display(90, 'ru')  # → "1ч 30мин"
format_duration_display(90, 'de')  # → "1Std 30Min"
format_duration_display(90, 'hi')  # → "1घंटा 30मिनट"
```

### МОЖЕТ СЛОМАТЬСЯ
- Если где-то в коде ожидается текстовый формат "1h 30min" вместо "90"
- Если при создании новой услуги duration записывается в старом формате
- Проверить API endpoints создания/обновления услуг

### TESTING
Проверено преобразование:
- "1h" → 60 → "1ч" (ru), "1h" (en), "1س" (ar) ✅
- "1h 30min" → 90 → "1ч 30мин" (ru), "1h 30min" (en) ✅  
- "90" → 90 → "1ч 30мин" ✅
- "2h" → 120 → "2ч" ✅

### ФАЙЛЫ
- `backend/utils/duration_utils.py` - NEW
- `backend/bot/tools.py` - MODIFIED (упрощен парсинг)
- `backend/bot/prompts.py` - MODIFIED (форматирование с учетом языка)
- `backend/db/employees.py` - MODIFIED (расчет занятых слотов)
- `backend/scripts/migrations/migrate_duration_to_minutes.py` - NEW
- `backend/scripts/maintenance/fix_data.py` - MODIFIED (добавлена fix_service_durations)
