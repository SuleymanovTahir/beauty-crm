# üî• Hotfix: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

## –ü—Ä–æ–±–ª–µ–º—ã

### 1. –¢–∞–±–ª–∏—Ü–∞ `user_status` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚ùå
```
psycopg2.errors.UndefinedTable: relation "user_status" does not exist
```
**–í–ª–∏—è–Ω–∏–µ:** –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å

### 2. Missing API Endpoints (404) ‚ùå
- `/api/telephony/settings`
- `/api/telephony/stats`
- `/api/telephony/analytics`
- –ò –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ...

**–í–ª–∏—è–Ω–∏–µ:** –°—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, –∑–∞–¥–∞—á, –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

### 3. –ß–∞—Ç—ã Instagram –∏ WhatsApp –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è ‚ùå
**–í–ª–∏—è–Ω–∏–µ:** –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### ‚úÖ 1. –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è `user_status`

**–§–∞–π–ª:** `backend/db/migrations/consolidated/schema_user_status.py`

–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É:
```sql
CREATE TABLE user_status (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    is_online BOOLEAN DEFAULT FALSE,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –≤:** `backend/db/migrations/run_all_migrations.py:251-255`

### ‚úÖ 2. –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ API endpoints –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏

**–§–∞–π–ª:** `backend/api/telephony.py:727-798`

–î–æ–±–∞–≤–ª–µ–Ω—ã endpoints:
- `GET /api/telephony/settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
- `GET /api/telephony/stats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤
- `GET /api/telephony/analytics` - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤

### ‚úÖ 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è)

**–§–∞–π–ª:** `backend/tests/test_utils.py`

–§—É–Ω–∫—Ü–∏—è `create_test_user()` —Ç–µ–ø–µ—Ä—å:
- –û—á–∏—â–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (user_schedule, schedule_breaks, time_off)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç duplicate key errors

## –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

```bash
cd /Users/tahir/Desktop/beauty-crm
./deploy.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

```bash
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è backend
rsync -avz --progress \
    --exclude='venv/' \
    --exclude='__pycache__/' \
    ./backend/ ubuntu@32.235:/home/ubuntu/beauty_crm/backend/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
ssh ubuntu@32.235 << 'EOF'
    sudo systemctl daemon-reload
    sudo systemctl restart beauty_crm
    sudo systemctl restart nginx
EOF

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
ssh ubuntu@32.235 'sudo journalctl -u beauty_crm -f'
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_status

```bash
ssh ubuntu@32.235 'psql beauty_crm -c "\d user_status"'
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã.

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞—Ç

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞—Ç
2. –î–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ `user_status does not exist`

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é

1. –û—Ç–∫—Ä–æ–π—Ç–µ: `/admin/telephony`
2. –í–∫–ª–∞–¥–∫–∞ "–°–ø–∏—Å–æ–∫ –∑–≤–æ–Ω–∫–æ–≤" –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è
3. –í–∫–ª–∞–¥–∫–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–∏–ª–∏ –ø—É—Å—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏)

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

```bash
ssh ubuntu@32.235 'sudo journalctl -u beauty_crm -n 100 | grep -i error'
```

–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
- ‚ùå `user_status does not exist`
- ‚ùå `404 /api/telephony/settings`
- ‚ùå `404 /api/telephony/stats`

## –û—Å—Ç–∞–≤—à–∏–µ—Å—è 404 –æ—à–∏–±–∫–∏

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ 404 –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –æ–Ω–∏ **–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ**:

### –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ):
- `/api/menu-settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ–Ω—é
- `/api/funnel/stages` - –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂
- `/api/products` - –ø—Ä–æ–¥—É–∫—Ç—ã/—Ç–æ–≤–∞—Ä—ã
- `/api/invoices` - —Å—á–µ—Ç–∞
- `/api/contracts` - –¥–æ–≥–æ–≤–æ—Ä—ã
- `/api/tasks` - –∑–∞–¥–∞—á–∏
- `/api/payment-providers` - –ø–ª–∞—Ç—ë–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- `/api/marketplace-providers` - –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã
- `/api/admin/audit-log` - –ª–æ–≥–∏ –∞—É–¥–∏—Ç–∞
- `/api/admin/trash` - –∫–æ—Ä–∑–∏–Ω–∞

–≠—Ç–∏ endpoints –Ω—É–∂–Ω—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω—ã.

## –ü—Ä–æ–±–ª–µ–º–∞ 3: –ß–∞—Ç—ã Instagram/WhatsApp

–≠—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Meta/WhatsApp

**TODO:** –ù—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤.

## Rollback (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
ssh ubuntu@32.235 << 'EOF'
    cd /home/ubuntu/beauty_crm
    # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
    sed -i 's/run_all_migrations()/# run_all_migrations()/' backend/main.py
    sudo systemctl restart beauty_crm
EOF
```

–ü–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞:
1. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —á–∞—Ç –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (user_status missing)
2. –ù–æ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

**–°–æ–∑–¥–∞–Ω–æ:** 11.01.2026
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:** ~2 –º–∏–Ω—É—Ç—ã
