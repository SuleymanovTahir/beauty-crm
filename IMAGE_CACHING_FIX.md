# üñºÔ∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–î–∞—Ç–∞:** 11.01.2026
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

## –ü—Ä–æ–±–ª–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
- –†–∞–∑–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
- –£–¥–∞–ª—è–ª —Å—Ç–∞—Ä—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∂–∞–ª –Ω–æ–≤—ã–µ —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º
- –í–æ–∑–º–æ–∂–Ω–æ –ø—É—Ç–∞–Ω–∏—Ü–∞ –º–µ–∂–¥—É `127.0.0.1` –∏ `mlediamant.com`

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë—Ä–∞—É–∑–µ—Ä—ã –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –∫—ç—à–∏—Ä—É—é—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º, –±—Ä–∞—É–∑–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ä–æ–µ –∏–∑ –∫—ç—à–∞.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ timestamp –∫ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

### 2. –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–∞–º–µ–Ω–µ —Ñ–∞–π–ª–∞ —Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º, –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è.

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
```
/static/uploads/photos/employee_123.jpg  (—Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ)
/static/uploads/photos/employee_123.jpg  (–Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ, —Ç–æ –∂–µ –∏–º—è)
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```
/static/uploads/photos/employee_123_v1.jpg
/static/uploads/photos/employee_123_v2.jpg
```

–ò–ª–∏ —Å timestamp:
```
/static/uploads/photos/employee_123_1736604000.jpg
/static/uploads/photos/employee_123_1736607600.jpg
```

### 3. –†–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã (127.0.0.1 vs mlediamant.com)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ —Ä–∞–∑–¥–µ–ª—å–Ω—ã–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤.

- –ù–∞ localhost (127.0.0.1) - –æ–¥–∏–Ω –∫—ç—à
- –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (mlediamant.com) - –¥—Ä—É–≥–æ–π –∫—ç—à

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –¢–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –Ω–∞ localhost - –≤–∏–¥–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –Ω–∞ mlediamant.com - –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ (–∏–∑ –∫—ç—à–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å query parameter —Å timestamp (–ë—ã—Å—Ç—Ä–æ–µ)

**–ì–¥–µ:** –í API endpoint, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ë—ã–ª–æ:
photo_url = f"/static/uploads/photos/{filename}"

# –°—Ç–∞–ª–æ:
import time
photo_url = f"/static/uploads/photos/{filename}?v={int(time.time())}"
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë—ã—Å—Ç—Ä–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå Query parameter –º–æ–∂–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ CDN
- ‚ùå –ù–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, –µ—Å–ª–∏ URL —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–∑–µ

### –†–µ—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å hash —Ñ–∞–π–ª–∞ –≤ –∏–º—è (–ù–∞–¥–µ–∂–Ω–æ–µ)

**–ì–¥–µ:** –í —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
import hashlib
from datetime import datetime

def upload_employee_photo(file, employee_id):
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Å timestamp
    timestamp = int(datetime.now().timestamp())
    ext = file.filename.split('.')[-1]
    new_filename = f"employee_{employee_id}_{timestamp}.{ext}"

    # –ò–ª–∏ —Å hash —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (–µ—â–µ –Ω–∞–¥–µ–∂–Ω–µ–µ):
    content = file.file.read()
    file_hash = hashlib.md5(content).hexdigest()[:8]
    new_filename = f"employee_{employee_id}_{file_hash}.{ext}"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    file_path = f"/static/uploads/photos/{new_filename}"
    # ... save file

    return file_path
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫—ç—à–∞

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ –∑–∞–≥—Ä—É–∑–∫–∏
- ‚ùå –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ (–Ω—É–∂–Ω–∞ –æ—á–∏—Å—Ç–∫–∞)

### –†–µ—à–µ–Ω–∏–µ 3: Cache-Control headers (–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)

**–ì–¥–µ:** –í nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `/etc/nginx/sites-available/beauty_crm`:**
```nginx
# –î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è
location /static/uploads/photos/ {
    alias /home/ubuntu/beauty_crm/backend/static/uploads/photos/;

    # –ö–æ—Ä–æ—Ç–∫–∏–π –∫—ç—à –¥–ª—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    add_header Cache-Control "public, max-age=3600, must-revalidate";

    # –ò–ª–∏ –≤–æ–æ–±—â–µ –±–µ–∑ –∫—ç—à–∞ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞):
    # add_header Cache-Control "no-cache, no-store, must-revalidate";
    # add_header Pragma "no-cache";
    # add_header Expires "0";
}

# –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ - –¥–æ–ª–≥–∏–π –∫—ç—à
location /static/ {
    alias /home/ubuntu/beauty_crm/backend/static/;
    add_header Cache-Control "public, max-age=31536000, immutable";
}
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –≠—Ç–∞–ø 1: –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞)

1. **–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞**
   - Chrome: Ctrl+Shift+Del ‚Üí –û—á–∏—Å—Ç–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ñ–∞–π–ª—ã
   - Firefox: Ctrl+Shift+Del ‚Üí –ö—ç—à
   - –ò–ª–∏ Hard Refresh: Ctrl+F5

2. **–î–æ–±–∞–≤–∏—Ç—å Cache-Control –≤ nginx** (—Å–º. –†–µ—à–µ–Ω–∏–µ 3)

### –≠—Ç–∞–ø 2: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ)

1. **–û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ** (–†–µ—à–µ–Ω–∏–µ 2)
   - –î–æ–±–∞–≤–∏—Ç—å timestamp –≤ –∏–º—è —Ñ–∞–π–ª–∞
   - –§–∞–π–ª: `backend/api/uploads.py` –∏–ª–∏ `backend/api/user_management.py`

2. **–û–±–Ω–æ–≤–∏—Ç—å API endpoints**
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–æ–≤—ã–µ URL –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É
   - –£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤—ã—Ö

3. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –≤ query string** (–†–µ—à–µ–Ω–∏–µ 1)
   - –ö–∞–∫ fallback –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Backend:

1. **`backend/api/uploads.py`** - —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
   - –î–æ–±–∞–≤–∏—Ç—å timestamp –≤ –∏–º—è —Ñ–∞–π–ª–∞
   - –£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã

2. **`backend/api/user_management.py`** - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏

3. **Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ Cache-Control headers

### –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è uploads.py:

```python
from datetime import datetime
import os
from pathlib import Path

async def upload_file_with_version(
    file: UploadFile,
    category: str,
    entity_id: str,
    subfolder: Optional[str] = None
) -> str:
    """
    –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    """
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    timestamp = int(datetime.now().timestamp())
    file_ext = file.filename.split('.')[-1] if '.' in file.filename else 'jpg'

    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –≤–µ—Ä—Å–∏–µ–π
    safe_filename = f"{entity_id}_{timestamp}.{file_ext}"

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —ç—Ç–æ–≥–æ entity_id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if category == "photos":
        old_pattern = f"{entity_id}_*.{file_ext}"
        old_files = list(UPLOAD_DIR_PATH.glob(f"{category}/{old_pattern}"))
        for old_file in old_files:
            try:
                old_file.unlink()
                logging.info(f"Deleted old file: {old_file}")
            except Exception as e:
                logging.warning(f"Could not delete old file {old_file}: {e}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
    if subfolder:
        target_dir = UPLOAD_DIR_PATH / category / subfolder
        public_path = f"/static/uploads/{category}/{subfolder}/{safe_filename}"
    else:
        target_dir = UPLOAD_DIR_PATH / category
        public_path = f"/static/uploads/{category}/{safe_filename}"

    target_dir.mkdir(parents=True, exist_ok=True)
    file_path = target_dir / safe_filename

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    content = await file.read()
    with open(file_path, 'wb') as f:
        f.write(content)

    return public_path
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç timestamp
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É - –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
4. ‚úÖ –û—Ç–∫—Ä—ã—Ç—å –≤ –¥—Ä—É–≥–æ–º –±—Ä–∞—É–∑–µ—Ä–µ - –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
5. ‚úÖ –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–º –¥–æ–º–µ–Ω–µ - –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

–ü–æ–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ:

1. **Hard Refresh –≤ –±—Ä–∞—É–∑–µ—Ä–µ:** Ctrl+F5 (Windows) –∏–ª–∏ Cmd+Shift+R (Mac)
2. **–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞**
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –†–µ—à–µ–Ω–∏–µ 2 (timestamp –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)
