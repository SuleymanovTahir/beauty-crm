import sys
import os
import sqlite3

# Add backend directory to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.config import DATABASE_NAME

def get_db_connection():
    conn = sqlite3.connect(DATABASE_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def seed_services():
    conn = get_db_connection()
    c = conn.cursor()

    print("ðŸš€ Seeding employee services...")

    # 1. Define Services to Create (if not exist)
    services_data = [
        # Mestan
        ("hair_treatment", "Hair Treatment", "Ð›ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð²Ð¾Ð»Ð¾Ñ", 300, "AED", "Hair Treatment", 60),
        ("hair_extension", "Hair extension", "ÐÐ°Ñ€Ð°Ñ‰Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð²Ð¾Ð»Ð¾Ñ", 1000, "AED", "Hair extension", 120),
        ("eyelashes", "Eyelashes", "Ð ÐµÑÐ½Ð¸Ñ†Ñ‹", 200, "AED", "Eyelashes/Eyebrows", 90),
        ("promo_service", "Promo", "ÐŸÑ€Ð¾Ð¼Ð¾", 100, "AED", "Promo", 60),
        
        # Simo
        ("hair_wash", "Hair wash", "ÐœÑ‹Ñ‚ÑŒÐµ Ð³Ð¾Ð»Ð¾Ð²Ñ‹", 50, "AED", "Hair", 30),
        ("hair_cut_kids", "Hair Cut Kids", "Ð”ÐµÑ‚ÑÐºÐ°Ñ ÑÑ‚Ñ€Ð¸Ð¶ÐºÐ°", 60, "AED", "Hair", 30),
        ("blow_dry", "Blow Dry", "Ð£ÐºÐ»Ð°Ð´ÐºÐ°", 100, "AED", "Hair", 45),
        
        # Lyazzat
        ("manicure", "Manicure", "ÐœÐ°Ð½Ð¸ÐºÑŽÑ€", 100, "AED", "Nails", 60),
        ("pedicure", "Pedicure", "ÐŸÐµÐ´Ð¸ÐºÑŽÑ€", 150, "AED", "Nails", 60),
        ("nail_extension", "Nail Extension", "ÐÐ°Ñ€Ð°Ñ‰Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð³Ñ‚ÐµÐ¹", 250, "AED", "Nails", 90),
        
        # Gulya
        ("waxing", "Waxing", "Ð’Ð¾ÑÐº", 100, "AED", "Depilation", 30),
        ("sugaring", "Sugaring", "Ð¨ÑƒÐ³Ð°Ñ€Ð¸Ð½Ð³", 120, "AED", "Depilation", 45),
    ]

    service_map = {} # key -> id

    for key, name, name_ru, price, currency, category, duration in services_data:
        # Check if exists
        c.execute("SELECT id FROM services WHERE service_key = ?", (key,))
        existing = c.fetchone()
        
        if existing:
            service_id = existing[0]
            # Update defaults
            c.execute("""UPDATE services SET 
                         name = ?, name_ru = ?, price = ?, category = ?, duration = ?
                         WHERE id = ?""", 
                      (name, name_ru, price, category, duration, service_id))
            print(f"âœ… Updated service: {name}")
        else:
            c.execute("""INSERT INTO services 
                         (service_key, name, name_ru, price, currency, category, duration, is_active)
                         VALUES (?, ?, ?, ?, ?, ?, ?, 1)""",
                      (key, name, name_ru, price, currency, category, duration))
            service_id = c.lastrowid
            print(f"âœ¨ Created service: {name}")
        
        service_map[key] = service_id

    conn.commit()

    # 2. Assign to Employees
    
    # Employee IDs (based on previous query)
    EMPLOYEES = {
        "Mestan": 8,
        "Simo": 9,
        "Lyazzat": 7,
        "Gulya": 5
    }

    assignments = [
        # Mestan
        ("Mestan", "hair_treatment", 300, 60),
        ("Mestan", "hair_extension", 1000, 120),
        ("Mestan", "eyelashes", 200, 90),
        ("Mestan", "promo_service", 100, 60),
        
        # Simo
        ("Simo", "hair_wash", 50, 30),
        ("Simo", "hair_cut_kids", 60, 30),
        ("Simo", "blow_dry", 100, 45),
        
        # Lyazzat
        ("Lyazzat", "manicure", 100, 60),
        ("Lyazzat", "pedicure", 150, 60),
        ("Lyazzat", "nail_extension", 250, 90),
        
        # Gulya
        ("Gulya", "waxing", 100, 30),
        ("Gulya", "sugaring", 120, 45),
    ]

    print("\nðŸš€ Assigning services to employees...")

    for emp_name, service_key, price, duration in assignments:
        emp_id = EMPLOYEES.get(emp_name)
        service_id = service_map.get(service_key)
        
        if not emp_id:
            print(f"âš ï¸ Employee {emp_name} not found, skipping assignment.")
            continue
            
        if not service_id:
            print(f"âš ï¸ Service {service_key} not found, skipping assignment.")
            continue

        # Check if already assigned
        c.execute("SELECT id FROM user_services WHERE user_id = ? AND service_id = ?", (emp_id, service_id))
        exists = c.fetchone()

        if exists:
            # Update
            c.execute("""UPDATE user_services 
                         SET price = ?, duration = ?, is_online_booking_enabled = 1, is_calendar_enabled = 1
                         WHERE user_id = ? AND service_id = ?""",
                      (price, duration, emp_id, service_id))
            print(f"ðŸ”„ Updated {emp_name} -> {service_key}")
        else:
            # Insert
            c.execute("""INSERT INTO user_services 
                         (user_id, service_id, price, duration, is_online_booking_enabled, is_calendar_enabled)
                         VALUES (?, ?, ?, ?, 1, 1)""",
                      (emp_id, service_id, price, duration))
            print(f"âž• Assigned {emp_name} -> {service_key}")

    conn.commit()
    conn.close()
    print("\nâœ… Done!")

if __name__ == "__main__":
    seed_services()
