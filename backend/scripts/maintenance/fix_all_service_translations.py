#!/usr/bin/env python3
"""
Comprehensive service translation fix:
1. Ensure all services have both name_ru and name_en
2. Remove any bad prefixes from descriptions
3. Set proper Russian descriptions
4. Clear bad translations to force re-translation
"""

import sys
from pathlib import Path

backend_dir = Path(__file__).parent.parent.parent
sys.path.insert(0, str(backend_dir))

from db.connection import get_db_connection

# Mapping of English names to Russian
TRANSLATIONS = {
    # Nails
    'acrylic extension': '–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –∞–∫—Ä–∏–ª–æ–º',
    'acrylic overlay': '–ü–æ–∫—Ä—ã—Ç–∏–µ –∞–∫—Ä–∏–ª–æ–º',
    'change gel': '–°–º–µ–Ω–∞ –≥–µ–ª—å-–ª–∞–∫–∞',
    'french': '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –º–∞–Ω–∏–∫—é—Ä',
    'gel extension': '–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –≥–µ–ª–µ–º',
    'gel overlay': '–ü–æ–∫—Ä—ã—Ç–∏–µ –≥–µ–ª–µ–º',
    'hard gel': '–¢–≤–µ—Ä–¥—ã–π –≥–µ–ª—å',
    'nail design': '–î–∏–∑–∞–π–Ω –Ω–æ–≥—Ç–µ–π',
    'pedicure basic': '–ë–∞–∑–æ–≤—ã–π –ø–µ–¥–∏–∫—é—Ä',
    'pedicure classic': '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–µ–¥–∏–∫—é—Ä',
    'pedicure gel': '–ü–µ–¥–∏–∫—é—Ä —Å –≥–µ–ª—å-–ª–∞–∫–æ–º',
    'podology': '–ü–æ–¥–æ–ª–æ–≥–∏—è',
    'remove classic': '–°–Ω—è—Ç–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –ª–∞–∫–∞',
    'remove gel': '–°–Ω—è—Ç–∏–µ –≥–µ–ª—å-–ª–∞–∫–∞',
    'remove nail extensions': '–°–Ω—è—Ç–∏–µ –Ω–∞—Ä–∞—â–µ–Ω–Ω—ã—Ö –Ω–æ–≥—Ç–µ–π',
    'spa pedicure': '–°–ü–ê-–ø–µ–¥–∏–∫—é—Ä',
    
    # Hair
    'hair cut': '–°—Ç—Ä–∏–∂–∫–∞',
    'hair wash': '–ú—ã—Ç—å–µ –≤–æ–ª–æ—Å',
    'hair style': '–£–∫–ª–∞–¥–∫–∞',
    'hair treatment': '–£—Ö–æ–¥ –∑–∞ –≤–æ–ª–æ—Å–∞–º–∏',
    'hair extension (only removal)': '–°–Ω—è—Ç–∏–µ –Ω–∞—Ä–∞—â–µ–Ω–Ω—ã—Ö –≤–æ–ª–æ—Å',
    'hair extensions (1 can)': '–ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ –≤–æ–ª–æ—Å (1 –∫–∞–ø—Å—É–ª–∞)',
    'trimming without wash': '–ü–æ–¥—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –±–µ–∑ –º—ã—Ç—å—è',
    
    # Massage
    'anti-cellulite massage': '–ê–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç–Ω—ã–π –º–∞—Å—Å–∞–∂',
    'back 30 min': '–ú–∞—Å—Å–∞–∂ —Å–ø–∏–Ω—ã 30 –º–∏–Ω',
    'back massage (5-10)': '–ú–∞—Å—Å–∞–∂ —Å–ø–∏–Ω—ã (–∫—É—Ä—Å)',
    'classic general massage': '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂',
    'full body 60 min': '–ú–∞—Å—Å–∞–∂ –≤—Å–µ–≥–æ —Ç–µ–ª–∞',
    'head 40 min': '–ú–∞—Å—Å–∞–∂ –≥–æ–ª–æ–≤—ã',
    'hotstone': '–°—Ç–æ—É–Ω-–º–∞—Å—Å–∞–∂',
    'leg/feet/ hand 40 min': '–ú–∞—Å—Å–∞–∂ –Ω–æ–≥/—Ä—É–∫',
    'moroccan bath loofa': '–ú–∞—Ä–æ–∫–∫–∞–Ω—Å–∫–∞—è –±–∞–Ω—è —Å –ª—é—Ñ–æ–π',
    'moroccan bathhouse': '–ú–∞—Ä–æ–∫–∫–∞–Ω—Å–∫–∞—è –±–∞–Ω—è',
    'neck & shoulder 30 min': '–ú–∞—Å—Å–∞–∂ —à–µ–∏ –∏ –ø–ª–µ—á',
    'sculpture body massage': '–°–∫—É–ª—å–ø—Ç—É—Ä–Ω—ã–π –º–∞—Å—Å–∞–∂',
    
    # Promo
    'blow dry packages 5': '–ü–∞–∫–µ—Ç —É–∫–ª–∞–¥–æ–∫ (5 —à—Ç)',
    'combo basic 150': '–ö–æ–º–±–æ –±–∞–∑–æ–≤—ã–π',
    'promo 390': '–ê–∫—Ü–∏—è 390',
    'promo mani pedi 250': '–ê–∫—Ü–∏—è –º–∞–Ω–∏–∫—é—Ä+–ø–µ–¥–∏–∫—é—Ä',
    'promotion overlay manicure': '–ê–∫—Ü–∏–æ–Ω–Ω—ã–π –º–∞–Ω–∏–∫—é—Ä',
    
    # Waxing
    'brazilian': '–ë—Ä–∞–∑–∏–ª—å—Å–∫–∞—è —ç–ø–∏–ª—è—Ü–∏—è',
    'cheeks': '–≠–ø–∏–ª—è—Ü–∏—è —â–µ–∫',
    'full body': '–≠–ø–∏–ª—è—Ü–∏—è –≤—Å–µ–≥–æ —Ç–µ–ª–∞',
    'under arms': '–≠–ø–∏–ª—è—Ü–∏—è –ø–æ–¥–º—ã—à–µ–∫',
    'upper lip': '–≠–ø–∏–ª—è—Ü–∏—è –≤–µ—Ä—Ö–Ω–µ–π –≥—É–±—ã',
}

def fix_all_services():
    """Comprehensive fix for all services"""
    
    print("üîß Comprehensive service translation fix...")
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        # 1. Get all services
        cursor.execute("SELECT id, name, name_ru, name_en FROM services")
        services = cursor.fetchall()
        
        print(f"\nüìã Processing {len(services)} services...")
        
        fixed_count = 0
        
        for service_id, name, name_ru, name_en in services:
            updates = {}
            
            # Determine the best Russian and English names
            current_ru = name_ru or name
            current_en = name_en or name
            
            # Check if we have a translation for this service
            if current_en:
                en_lower = current_en.lower().strip()
                if en_lower in TRANSLATIONS:
                    updates['name_ru'] = TRANSLATIONS[en_lower]
                    updates['name_en'] = current_en
                elif not current_ru or current_ru == current_en:
                    # No Russian name, keep as-is for now
                    updates['name_ru'] = current_en
                    updates['name_en'] = current_en
            
            # Update if we have changes
            if updates:
                set_clause = ', '.join([f"{k} = %s" for k in updates.keys()])
                values = list(updates.values()) + [service_id]
                cursor.execute(f"UPDATE services SET {set_clause} WHERE id = %s", values)
                
                print(f"   ‚úÖ ID {service_id}: {current_en} ‚Üí {updates.get('name_ru', current_ru)}")
                fixed_count += 1
        
        # 2. Clear all bad descriptions (will be regenerated by translation system)
        print("\nüßπ Clearing bad descriptions...")
        cursor.execute("""
            UPDATE services
            SET description = NULL,
                description_en = NULL,
                description_ar = NULL,
                description_de = NULL,
                description_es = NULL,
                description_fr = NULL,
                description_hi = NULL,
                description_kk = NULL,
                description_pt = NULL
            WHERE description LIKE '%–£—Å–ª—É–≥–∞:%' 
               OR description LIKE '%Service:%'
               OR description LIKE '%–°–ª—É–∂–±–∞:%'
               OR description LIKE '%–°–µ—Ä–≤–∏—Å:%'
        """)
        
        print("   ‚úÖ Cleared bad descriptions")
        
        conn.commit()
        print(f"\n‚úÖ Fixed {fixed_count} services!")
        print("\nüí° Next: Run 'npm run db:i18n:auto' to regenerate all translations")
        
    except Exception as e:
        conn.rollback()
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
        raise
    finally:
        cursor.close()
        conn.close()

if __name__ == "__main__":
    fix_all_services()
