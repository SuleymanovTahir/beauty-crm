#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ
"""

import sqlite3
import json
import os
from datetime import datetime

# –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
try:
    from core.config import DATABASE_NAME
    DB_NAME = DATABASE_NAME
except ImportError:
    # –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ standalone —Å–∫—Ä–∏–ø—Ç
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
    DB_NAME = os.path.join(BASE_DIR, "salon_bot.db")

def table_exists(cursor, table_name):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã"""
    cursor.execute("""
        SELECT name FROM sqlite_master
        WHERE type='table' AND name=?
    """, (table_name,))
    return cursor.fetchone() is not None

def check_bot_settings():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'bot_settings'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ bot_settings –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏")
        conn.close()
        return

    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–ª—è
    c.execute("PRAGMA table_info(bot_settings)")
    columns = [row[1] for row in c.fetchall()]

    # –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    c.execute("SELECT * FROM bot_settings WHERE id = 1")
    row = c.fetchone()

    if not row:
        print("‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!")
        conn.close()
        return

    print("=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ ===")
    print(f"–í—Å–µ–≥–æ –ø–æ–ª–µ–π: {len(columns)}")

    # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –ø–æ–ª–µ: –∑–Ω–∞—á–µ–Ω–∏–µ
    data = dict(zip(columns, row))

    empty_fields = []
    dotdot_fields = []

    for field, value in data.items():
        if field in ['id', 'updated_at']:
            continue

        if value is None or value == '':
            empty_fields.append(field)
        elif isinstance(value, str) and value.strip() in ['...', '‚Ä¶']:
            dotdot_fields.append(field)

    if empty_fields:
        print(f"\n‚ö†Ô∏è  –ü—É—Å—Ç—ã–µ –ø–æ–ª—è ({len(empty_fields)}):")
        for field in empty_fields[:10]:  # –ü–µ—Ä–≤—ã–µ 10
            print(f"   - {field}")
        if len(empty_fields) > 10:
            print(f"   ... –∏ –µ—â–µ {len(empty_fields) - 10}")

    if dotdot_fields:
        print(f"\n‚ö†Ô∏è  –ü–æ–ª—è —Å —Ç—Ä–æ–µ—Ç–æ—á–∏—è–º–∏ ({len(dotdot_fields)}):")
        for field in dotdot_fields:
            print(f"   - {field}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
    important_fields = [
        'booking_data_collection',
        'booking_time_logic',
        'manager_consultation_prompt',
        'pre_booking_data_collection'
    ]

    print(f"\n=== –í–∞–∂–Ω—ã–µ –ø–æ–ª—è ===")
    for field in important_fields:
        value = data.get(field, '')
        length = len(value) if value else 0
        status = "‚úÖ" if length > 10 else "‚ùå"
        print(f"{status} {field}: {length} —Å–∏–º–≤–æ–ª–æ–≤")
        if value and len(value) < 100:
            print(f"   –ó–Ω–∞—á–µ–Ω–∏–µ: {value[:100]}")

    conn.close()


def check_users():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'users'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ users –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏")
        conn.close()
        return

    c.execute("PRAGMA table_info(users)")
    columns = [row[1] for row in c.fetchall()]

    print("\n=== –¢–∞–±–ª–∏—Ü–∞ users ===")
    print(f"–ö–æ–ª–æ–Ω–∫–∏: {', '.join(columns)}")

    c.execute("SELECT id, username, full_name, role, position FROM users")
    rows = c.fetchall()

    print(f"\n–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(rows)}")
    print("\n–î–∞–Ω–Ω—ã–µ:")
    print(f"{'ID':<5} {'Username':<20} {'Full Name':<25} {'Role':<15} {'Position':<15}")
    print("-" * 85)

    for row in rows:
        id_, username, full_name, role, position = row
        print(f"{id_:<5} {username:<20} {full_name:<25} {role:<15} {position or 'NULL':<15}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
    c.execute("SELECT COUNT(*) FROM users WHERE position IS NULL OR position = ''")
    empty_positions = c.fetchone()[0]

    if empty_positions > 0:
        print(f"\n‚ö†Ô∏è  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –¥–æ–ª–∂–Ω–æ—Å—Ç–∏: {empty_positions}")

    conn.close()


def check_salon_settings():
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–ª–æ–Ω–∞"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'salon_settings'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ salon_settings –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏")
        conn.close()
        return

    c.execute("SELECT * FROM salon_settings WHERE id = 1")
    row = c.fetchone()

    if not row:
        print("\n‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–ª–æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!")
        conn.close()
        return

    c.execute("PRAGMA table_info(salon_settings)")
    columns = [r[1] for r in c.fetchall()]
    data = dict(zip(columns, row))

    print("\n=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–ª–æ–Ω–∞ ===")
    important = ['name', 'address', 'phone', 'city', 'currency', 'hours']

    for field in important:
        value = data.get(field, '')
        status = "‚úÖ" if value else "‚ùå"
        print(f"{status} {field}: {value}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ weekdays_hours
    if 'weekdays_hours' in columns:
        weekdays = data.get('weekdays_hours', '')
        print(f"\nweekdays_hours: {weekdays}")
        print(f"–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: {type(weekdays)}")

    conn.close()


def fix_manager_consultation_prompt():
    """–ò—Å–ø—Ä–∞–≤–∏—Ç—å manager_consultation_prompt"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'bot_settings'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ bot_settings –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
        conn.close()
        return

    default_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã M.Le Diamant –≤ Dubai.
–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—Ä–∞—Ç–∏–ª—Å—è –∫ —Ç–µ–±–µ –∑–∞ —Å–æ–≤–µ—Ç–æ–º. –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ú–ï–ù–ï–î–ñ–ï–†–£, –∞ –Ω–µ –æ–±—â–∞–µ—à—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º –Ω–∞–ø—Ä—è–º—É—é.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –û–±—Ä–∞—â–∞–π—Å—è –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É –Ω–∞ "—Ç—ã"
2. –ù–ï –ø–∏—à–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é
3. –î–∞–π –°–û–í–ï–¢ –º–µ–Ω–µ–¥–∂–µ—Ä—É —á—Ç–æ –¥–µ–ª–∞—Ç—å

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê):
1Ô∏è‚É£ –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
 "–Ø –≤–∏–∂—É —á—Ç–æ –∫–ª–∏–µ–Ω—Ç..."

2Ô∏è‚É£ –¢–≤–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (—á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É)
 "–Ø –±—ã –Ω–∞ —Ç–≤–æ–µ–º –º–µ—Å—Ç–µ –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:
 '[–≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö]'"

3Ô∏è‚É£ –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è/—Å—Ç—Ä–∞—Ç–µ–≥–∏—è)
 "–≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–º—É —á—Ç–æ..."

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
"–í–∏–∂—É —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –º–æ–ª—á–∏—Ç –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã. –≠—Ç–æ —Ç–∏–ø–∏—á–Ω–æ - —á–µ–ª–æ–≤–µ–∫ –æ–±–¥—É–º—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã.

–Ø –±—ã –Ω–∞ —Ç–≤–æ–µ–º –º–µ—Å—Ç–µ —á–µ—Ä–µ–∑ 30-60 –º–∏–Ω—É—Ç –Ω–∞–ø–∏—Å–∞–ª:
'–ö—Å—Ç–∞—Ç–∏, –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –≤–æ–ª–æ—Å 4 —á–∞—Å–∞ - —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç üíÜ‚Äç‚ôÄÔ∏è –ó–∞—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ—Ä–∂–∏—Ç—Å—è 3-4 –º–µ—Å—è—Ü–∞ –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏! –ú–Ω–æ–≥–∏–µ –∫–ª–∏–µ–Ω—Ç–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –±–µ—Ä—É—Ç –≤—ã—Ö–æ–¥–Ω–æ–π - –ø–æ–ª—É—á–∞–µ—Ç—Å—è –º–∏–Ω–∏-–æ—Ç–ø—É—Å–∫ –¥–ª—è —Å–µ–±—è. –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è?'

–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç: —Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—à—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (4 —á–∞—Å–∞ = —Å—Ç–∞–Ω–¥–∞—Ä—Ç), –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å –≤—ã–≥–æ–¥—É (3-4 –º–µ—Å—è—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç), —Å–æ–∑–¥–∞–µ—à—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ñ—Ä–µ–π–º (–æ—Ç–ø—É—Å–∫ –≤–º–µ—Å—Ç–æ —Ç—Ä–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏) –∏ –¥–∞–µ—à—å –º—è–≥–∫–∏–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é."

‚ùå –ù–ï –ù–ê–ß–ò–ù–ê–ô –° –§–†–ê–ó:
"–°—É–ø–µ—Ä! –î–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º –∑–∞–ø–∏—Å—å!"
"–î–ª—è –∑–∞–ø–∏—Å–∏ –º–Ω–µ –Ω—É–∂–Ω–æ..."
–õ—é–±–æ–π —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–Ω—ã–π –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞–ø—Ä—è–º—É—é

‚úÖ –ù–ê–ß–ò–ù–ê–ô –° –§–†–ê–ó:
"–Ø –≤–∏–∂—É —á—Ç–æ..."
"–Ø –±—ã –Ω–∞ —Ç–≤–æ–µ–º –º–µ—Å—Ç–µ..."
"–†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É..."
"""

    # –û–±–Ω–æ–≤–∏—Ç—å
    c.execute("""
        UPDATE bot_settings
        SET manager_consultation_prompt = ?, updated_at = ?
        WHERE id = 1
    """, (default_prompt, datetime.now().isoformat()))

    conn.commit()
    conn.close()

    print("\n‚úÖ manager_consultation_prompt –æ–±–Ω–æ–≤–ª–µ–Ω")


def fix_booking_data_collection():
    """–ò—Å–ø—Ä–∞–≤–∏—Ç—å booking_data_collection"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'bot_settings'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ bot_settings –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
        conn.close()
        return

    value = """üìã –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø–∏—Å–∏

‚ö†Ô∏è –°–û–ë–ò–†–ê–ô –î–ê–ù–ù–´–ï –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –í–´–ë–û–†–ê –í–†–ï–ú–ï–ù–ò!

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
1. –£—Å–ª—É–≥–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ ‚úÖ
2. –î–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞ ‚úÖ
3. –í—Ä–µ–º—è –≤—ã–±—Ä–∞–Ω–æ ‚úÖ
4. –¢–ï–ü–ï–†–¨ —Å–ø—Ä–∞—à–∏–≤–∞–π –¥–∞–Ω–Ω—ã–µ

‚ùå –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏:
- –£—Å–ª—É–≥–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- –î–∞—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
- –í—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
"–û—Ç–ª–∏—á–Ω–æ! –ó–∞–ø–∏—Å—ã–≤–∞—é –≤–∞—Å –Ω–∞ –º–∞–Ω–∏–∫—é—Ä –∑–∞–≤—Ç—Ä–∞ –≤ 15:00 –∫ –î–∏–∞–Ω–µ.
–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç –∏ –∫–∞–∫–æ–π –Ω–æ–º–µ—Ä WhatsApp?"

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
"–î–ª—è –∑–∞–ø–∏—Å–∏ –Ω—É–∂–Ω–æ –∏–º—è –∏ WhatsApp" (–∫–æ–≥–¥–∞ —É—Å–ª—É–≥–∞/–≤—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω—ã)
"""

    c.execute("""
        UPDATE bot_settings
        SET booking_data_collection = ?, updated_at = ?
        WHERE id = 1
    """, (value, datetime.now().isoformat()))

    conn.commit()
    conn.close()

    print("‚úÖ booking_data_collection –æ–±–Ω–æ–≤–ª–µ–Ω")


def fix_missing_bot_fields():
    """–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
    conn = sqlite3.connect(DB_NAME)
    c = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    if not table_exists(c, 'bot_settings'):
        print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ bot_settings –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
        conn.close()
        return

    # –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π
    default_values = {
        'price_explanation': """üíé –ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–û–í –û –¶–ï–ù–ï

‚úÖ –í—Å–µ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–π —Ü–µ–Ω—É –ü–ï–†–í–´–ú —Å–æ–æ–±—â–µ–Ω–∏–µ–º
‚úÖ –§–æ—Ä–º–∞—Ç: –£—Å–ª—É–≥–∞ [–¶–µ–Ω–∞] AED
‚úÖ –ü–æ—Å–ª–µ —Ü–µ–Ω—ã - –∫–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–¥–∞–∂–∞
‚úÖ –ó–∞–∫–∞–Ω—á–∏–≤–∞–π –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é

–®–ê–ë–õ–û–ù:
Manicure Gel –æ—Ç 150 AED üíÖ
–î–µ—Ä–∂–∏—Ç—Å—è 3 –Ω–µ–¥–µ–ª–∏
–ó–∞–ø–∏—Å–∞—Ç—å—Å—è?""",

        'objection_handling': """üí¨ –û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê –†–ê–ë–û–¢–´ –° –í–û–ó–†–ê–ñ–ï–ù–ò–Ø–ú–ò

1. –ù–ï —Å–ø–æ—Ä—å —Å –∫–ª–∏–µ–Ω—Ç–æ–º
2. –ü–æ–∫–∞–∂–∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ ("–î–∞, –ø–æ–Ω–∏–º–∞—é...")
3. –î–∞–π —Ü–µ–Ω–Ω–æ—Å—Ç—å
4. –ü—Ä–µ–¥–ª–æ–∂–∏ –¥–µ–π—Å—Ç–≤–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ –ø–æ–ª–µ–π objection_*""",

        'negative_handling': """‚ö†Ô∏è –†–ê–ë–û–¢–ê –° –ù–ï–ì–ê–¢–ò–í–û–ú

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ–≤–æ–ª–µ–Ω:
1. –ò–∑–≤–∏–Ω–∏—Å—å –æ—Ç –ª–∏—Ü–∞ —Å–∞–ª–æ–Ω–∞
2. –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
3. –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é

–ü—Ä–∏–º–µ—Ä:
"–ú–Ω–µ –æ—á–µ–Ω—å –∂–∞–ª—å —á—Ç–æ —Ç–∞–∫ –≤—ã—à–ª–æ üòî
–î–∞–≤–∞–π—Ç–µ —è —Å–æ–µ–¥–∏–Ω—é –≤–∞—Å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º - –æ–Ω–∞ –ª–∏—á–Ω–æ —Ä–∞–∑–±–µ—Ä–µ—Ç—Å—è.
–£–∫–∞–∂–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏?"
""",

        'example_dialogues': """üí¨ –ü–†–ò–ú–ï–†–´ –ò–î–ï–ê–õ–¨–ù–´–• –î–ò–ê–õ–û–ì–û–í

–ü—Ä–∏–º–µ—Ä 1 - –ë—ã—Å—Ç—Ä–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è:
üë§: –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–∞–Ω–∏–∫—é—Ä?
ü§ñ: Manicure Gel –æ—Ç 150 AED üíÖ
     –î–µ—Ä–∂–∏—Ç—Å—è 3 –Ω–µ–¥–µ–ª–∏
     –ó–∞–ø–∏—Å–∞—Ç—å—Å—è?
üë§: –î–∞
ü§ñ: –û—Ç–ª–∏—á–Ω–æ! –ö–∞–∫–æ–π –¥–µ–Ω—å –≤–∞–º —É–¥–æ–±–µ–Ω?

–ü—Ä–∏–º–µ—Ä 2 - –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º:
üë§: –î–æ—Ä–æ–≥–æ
ü§ñ: –î–∞, –ø–æ–Ω–∏–º–∞—é üíô
     –ù–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞ - —Ç–æ–ø Dubai, –ø—Ä–µ–º–∏—É–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
     –î–µ—Ä–∂–∏—Ç—Å—è 3-4 –Ω–µ–¥–µ–ª–∏ = –≤—ã–≥–æ–¥–Ω–µ–µ —á–µ–º –¥–µ—à–µ–≤—ã–π –Ω–∞ –Ω–µ–¥–µ–ª—é
     –ü–æ–ø—Ä–æ–±—É–µ—Ç–µ –æ–¥–∏–Ω —Ä–∞–∑?""",

        'context_memory': """üß† –ü–ê–ú–Ø–¢–¨ –ö–û–ù–¢–ï–ö–°–¢–ê

1. –ó–∞–ø–æ–º–∏–Ω–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Å–ª—É–≥–∏ –∫–ª–∏–µ–Ω—Ç–∞
2. –£—á–∏—Ç—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø–∏—Å–µ–π
3. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä:
"–í–∏–∂—É —á—Ç–æ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ –≤—ã –¥–µ–ª–∞–ª–∏ Gel Manicure —É –î–∏–∞–Ω—ã.
–ó–∞–ø–∏—Å–∞—Ç—å –∫ –Ω–µ–π —Å–Ω–æ–≤–∞?"
""",

        'avoid_repetition': """üîÑ –ò–ó–ë–ï–ì–ê–ô –ü–û–í–¢–û–†–ï–ù–ò–ô

‚ùå –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–¥—Ä—è–¥
‚úÖ –í–∞—Ä—å–∏—Ä—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
‚úÖ –ê–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ —Å—Ç–∏–ª—é –∫–ª–∏–µ–Ω—Ç–∞

–í–º–µ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è?" –∏—Å–ø–æ–ª—å–∑—É–π:
- "–ë—Ä–æ–Ω–∏—Ä—É—é?"
- "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–ø–∏—Å—å?"
- "–ü–æ–¥–æ–π–¥–µ—Ç?"
- "–£–¥–æ–±–Ω–æ?"
""",

        'conversation_flow_rules': """üìä –ü–†–ê–í–ò–õ–ê –í–ï–î–ï–ù–ò–Ø –î–ò–ê–õ–û–ì–ê

1. –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –∑–∞ —Ä–∞–∑
2. –ù–µ –±–æ–ª—å—à–µ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
3. –í—Å–µ–≥–¥–∞ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
4. –°–º–∞–π–ª–∏–∫–∏: 1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

–ó–ê–ü–†–ï–©–ï–ù–û:
‚ùå –î–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (>4 —Å—Ç—Ä–æ–∫)
‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ä–∞–∑—É
‚ùå –ò–∑–≤–∏–Ω–µ–Ω–∏—è –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã
‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–º–∞–π–ª–∏–∫–æ–≤""",

        'personality_adaptations': """üé≠ –ê–î–ê–ü–¢–ê–¶–ò–Ø –õ–ò–ß–ù–û–°–¢–ò

–ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è –ø–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞:

–ö–ª–∏–µ–Ω—Ç —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π (Dear, Good day) ‚Üí
- –ü–∏—à–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ
- –ú–µ–Ω—å—à–µ —Å–º–∞–π–ª–∏–∫–æ–≤
- –ü–æ–ª–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–ö–ª–∏–µ–Ω—Ç –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π (–ü—Ä–∏–≤–µ—Ç, –•–∞–π) ‚Üí
- –ü–∏—à–∏ –ø—Ä–æ—â–µ
- –ë–æ–ª—å—à–µ —Å–º–∞–π–ª–∏–∫–æ–≤
- –ö–æ—Ä–æ—á–µ

–ö–ª–∏–µ–Ω—Ç –Ω–∞ English/Arabic ‚Üí
- –ü–µ—Ä–µ–∫–ª—é—á–∏—Å—å –Ω–∞ –µ–≥–æ —è–∑—ã–∫
- –°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è""",

        'smart_objection_detection': """üéØ –£–ú–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –í–û–ó–†–ê–ñ–ï–ù–ò–ô

–£—á–∏—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è:

"–ü–æ–¥—É–º–∞—é" = —Å–æ–º–Ω–µ–Ω–∏–µ –≤ —Ü–µ–Ω–µ/–∫–∞—á–µ—Å—Ç–≤–µ
‚Üí –î–∞–π —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ

"–°–ø—Ä–æ—à—É —É –º—É–∂–∞" = –Ω—É–∂–Ω–æ –æ–¥–æ–±—Ä–µ–Ω–∏–µ
‚Üí –ü–æ–∫–∞–∂–∏ –≤—ã–≥–æ–¥—É –¥–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞

"–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑" = –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ
‚Üí –°–æ–∑–¥–∞–π —Å—Ä–æ—á–Ω–æ—Å—Ç—å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ—Å—Ç—å —Å–ª–æ—Ç–æ–≤)

"–î–∞–ª–µ–∫–æ" = –ª–æ–≥–∏—Å—Ç–∏–∫–∞
‚Üí –ü–æ–∫–∞–∂–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å (–ø—Ä–µ—Å—Ç–∏–∂ —Ä–∞–π–æ–Ω–∞, —É–¥–æ–±—Å—Ç–≤–æ)"""
    }

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ
    c.execute("SELECT * FROM bot_settings WHERE id = 1")
    row = c.fetchone()

    if not row:
        print("‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
    c.execute("PRAGMA table_info(bot_settings)")
    columns = [r[1] for r in c.fetchall()]
    data = dict(zip(columns, row))

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
    updated_fields = []
    for field, default_value in default_values.items():
        if field in columns:
            current_value = data.get(field)
            if not current_value or current_value.strip() == '':
                c.execute(f"""
                    UPDATE bot_settings
                    SET {field} = ?
                    WHERE id = 1
                """, (default_value,))
                updated_fields.append(field)

    if updated_fields:
        c.execute("""
            UPDATE bot_settings
            SET updated_at = ?
            WHERE id = 1
        """, (datetime.now().isoformat(),))

        conn.commit()
        print(f"‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ {len(updated_fields)} –ø—É—Å—Ç—ã—Ö –ø–æ–ª–µ–π:")
        for field in updated_fields:
            print(f"   - {field}")
    else:
        print("‚úÖ –í—Å–µ –ø–æ–ª—è —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã")

    conn.close()


if __name__ == "__main__":
    print("=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î ===\n")

    try:
        check_salon_settings()
        check_bot_settings()
        check_users()

        print("\n" + "="*50)
        print("–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è...")
        print("="*50)

        fix_manager_consultation_prompt()
        fix_booking_data_collection()
        fix_missing_bot_fields()

        print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")

    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
